name: Content Strategy Reports

on:
  schedule:
    # Run every Monday at 9 AM UTC
    - cron: '0 9 * * 1'
  workflow_dispatch: # Allow manual trigger

jobs:
  generate-reports:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Generate Content Calendar Report
        run: node scripts/content-calendar.js
        continue-on-error: true

      - name: Generate Competitor Analysis Report
        run: node scripts/competitor-analysis.js
        continue-on-error: true

      - name: Generate Content Repurposing Report
        run: node scripts/content-repurposing.js
        continue-on-error: true

      - name: Upload Reports as Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: content-strategy-reports-${{ github.run_number }}
          path: |
            reports/content-calendar-report.md
            reports/content-calendar-report.json
            reports/content-calendar.ics
            reports/competitor-analysis-report.md
            reports/competitor-analysis-report.json
            reports/content-repurposing-report.md
            reports/content-repurposing-report.json
          retention-days: 90

      - name: Upload Repurposing Guides
        uses: actions/upload-artifact@v4
        with:
          name: repurposing-guides-${{ github.run_number }}
          path: content-repurposing/**/*.md
          retention-days: 90
        continue-on-error: true

      - name: Commit Reports to Repository
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add reports/*.md reports/*.json reports/*.ics
          git diff --quiet && git diff --staged --quiet || git commit -m "üìä Weekly content strategy reports [automated]"
          git push
        continue-on-error: true

      - name: Create Issue with Summary
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            
            // Read the reports
            let calendarReport = '';
            let competitorReport = '';
            let repurposingReport = '';
            
            try {
              calendarReport = fs.readFileSync('reports/content-calendar-report.md', 'utf8');
            } catch (e) {
              calendarReport = 'Report not generated';
            }
            
            try {
              competitorReport = fs.readFileSync('reports/competitor-analysis-report.md', 'utf8');
            } catch (e) {
              competitorReport = 'Report not generated';
            }
            
            try {
              repurposingReport = fs.readFileSync('reports/content-repurposing-report.md', 'utf8');
            } catch (e) {
              repurposingReport = 'Report not generated';
            }
            
            // Create issue with summary
            const issueBody = `# üìä Weekly Content Strategy Report
            
            This is your automated weekly content strategy report generated on ${new Date().toLocaleDateString()}.
            
            ## üìÖ Content Calendar
            
            <details>
            <summary>View Full Report</summary>
            
            ${calendarReport.split('\n').slice(0, 50).join('\n')}
            
            [View complete report in artifacts]
            </details>
            
            ## üîç Competitor Analysis
            
            <details>
            <summary>View Full Report</summary>
            
            ${competitorReport.split('\n').slice(0, 50).join('\n')}
            
            [View complete report in artifacts]
            </details>
            
            ## üîÑ Content Repurposing Opportunities
            
            <details>
            <summary>View Full Report</summary>
            
            ${repurposingReport.split('\n').slice(0, 50).join('\n')}
            
            [View complete report in artifacts]
            </details>
            
            ---
            
            **Action Items:**
            - Review the full reports in the [workflow artifacts](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
            - Import \`content-calendar.ics\` to Google Calendar
            - Update competitor data in \`data/competitors.json\`
            - Update trending topics in \`data/trending-topics.json\`
            - Implement high-priority recommendations
            
            *This issue was automatically generated by the Content Strategy workflow.*`;
            
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `üìä Weekly Content Strategy Report - ${new Date().toLocaleDateString()}`,
              body: issueBody,
              labels: ['content-strategy', 'automated-report']
            });
