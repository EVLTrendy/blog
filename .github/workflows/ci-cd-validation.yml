name: CI/CD with SEO Validation

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  validate-and-build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run frontmatter validation with auto-fix
        run: npm run validate:fix

      - name: Build and validate site
        run: npm run build:safe

      - name: Upload validation report
        if: always()
        continue-on-error: true
        uses: actions/upload-artifact@v4
        with:
          name: frontmatter-validation-report
          path: reports/frontmatter-validation-report.json
          retention-days: 30
          if-no-files-found: ignore

      - name: Upload API validation report
        if: always()
        continue-on-error: true
        uses: actions/upload-artifact@v4
        with:
          name: api-validation-results
          path: public/api/posts.json
          retention-days: 7
          if-no-files-found: ignore

      - name: Upload build artifacts
        if: success()
        continue-on-error: true
        uses: actions/upload-artifact@v4
        with:
          name: built-site
          path: public/
          retention-days: 7
          if-no-files-found: warn

      - name: Comment PR with validation results
        if: github.event_name == 'pull_request'
        continue-on-error: true
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const reportPath = 'reports/frontmatter-validation-report.json';

            if (fs.existsSync(reportPath)) {
              try {
                const report = JSON.parse(fs.readFileSync(reportPath, 'utf8'));
                const summary = report.summary || {};

                let comment = '## üîç SEO Validation Report\n\n';
                comment += `**Total Files:** ${summary.totalFiles || 0}\n`;
                comment += `**Errors:** ${summary.errors || 0}\n`;
                comment += `**Warnings:** ${summary.warnings || 0}\n\n`;

                if (report.warnings && report.warnings.length > 0) {
                  comment += '### ‚ö†Ô∏è Warnings:\n';
                  report.warnings.slice(0, 10).forEach(warning => {
                    comment += `- **${warning.file}**: ${warning.message}\n`;
                  });
                  if (report.warnings.length > 10) {
                    comment += `- ... and ${report.warnings.length - 10} more warnings\n`;
                  }
                  comment += '\n';
                }

                if (report.errors && report.errors.length > 0) {
                  comment += '### ‚ùå Errors:\n';
                  report.errors.slice(0, 10).forEach(error => {
                    comment += `- **${error.file}**: ${error.message}\n`;
                  });
                  if (report.errors.length > 10) {
                    comment += `- ... and ${report.errors.length - 10} more errors\n`;
                  }
                  comment += '\n';
                }

                if ((summary.errors || 0) === 0 && (summary.warnings || 0) === 0) {
                  comment += '‚úÖ **All validation checks passed!**';
                } else if ((summary.errors || 0) === 0) {
                  comment += '‚ö†Ô∏è **Warnings found, but build succeeded.**';
                } else {
                  comment += 'üîß **Please review the issues above.**';
                }

                github.rest.issues.createComment({
                  issue_number: context.issue.number,
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  body: comment
                });
              } catch (e) {
                console.log('Error parsing validation report:', e.message);
              }
            }
