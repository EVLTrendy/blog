<!doctype html>
<html>

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="robots" content="noindex" />
  <title>Complete Content Management System</title>
  <link rel="icon" type="image/x-icon" href="/assets/blog/favicon.ico">
  <link rel="stylesheet" href="https://unpkg.com/sakura.css/css/sakura.css">
  <!-- SimpleMDE for Rich Text Editing -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/simplemde/latest/simplemde.min.css">
  <script src="https://cdn.jsdelivr.net/simplemde/latest/simplemde.min.js"></script>
  <!-- Font Awesome for SimpleMDE icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css">
  <style>
    /* Reset Sakura constraints for full-width CMS layout */
    body {
      max-width: 100% !important;
      padding: 0 !important;
      margin: 0 !important;
      background-color: #f0f2f5;
    }

    .cms-sidebar {
      position: fixed;
      left: 0;
      top: 0;
      width: 260px;
      height: 100vh;
      background: #ffffff;
      padding: 25px 35px 25px 25px;
      overflow-y: auto;
      border-right: 1px solid #e1e4e8;
      box-shadow: 2px 0 5px rgba(0, 0, 0, 0.03);
      z-index: 100;
    }

    .cms-main {
      margin-left: 300px;
      padding: 40px;
      max-width: 1600px;
      margin-right: auto;
    }

    .cms-nav-item {
      display: block;
      padding: 12px 15px;
      margin: 8px 0;
      text-decoration: none;
      color: #4a5568;
      border-radius: 8px;
      transition: all 0.2s ease;
      font-weight: 500;
      cursor: pointer;
    }

    .cms-nav-item:hover,
    .cms-nav-item.active {
      background: #33bdef;
      color: white;
      transform: translateX(5px);
    }

    .content-section {
      display: none;
      animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .content-section.active {
      display: block;
    }

    .content-list {
      margin: 25px 0;
      display: grid;
      gap: 15px;
    }

    .content-item {
      padding: 20px;
      border: 1px solid #e2e8f0;
      margin: 0;
      background: #ffffff;
      border-radius: 10px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.02);
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .content-item:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    }

    .content-item h4 {
      margin: 0 0 10px 0;
      font-size: 1.1em;
      color: #2d3748;
    }

    .content-meta {
      color: #718096;
      font-size: 0.9em;
      line-height: 1.5;
    }

    .content-actions {
      margin-top: 15px;
      display: flex;
      gap: 10px;
    }

    .form-section {
      display: none;
      animation: fadeIn 0.3s;
    }

    .form-section.active {
      display: block;
    }

    .btn {
      padding: 10px 20px;
      margin: 0;
      cursor: pointer;
      border: 1px solid transparent;
      background: #edf2f7;
      border-radius: 6px;
      font-weight: 500;
      transition: all 0.2s;
    }

    .btn:hover {
      filter: brightness(95%);
      transform: translateY(-1px);
    }

    .btn.primary {
      background: #33bdef;
      color: white;
      box-shadow: 0 2px 4px rgba(51, 189, 239, 0.3);
    }

    .btn.primary:hover {
      background: #2daadd;
      box-shadow: 0 4px 6px rgba(51, 189, 239, 0.4);
    }

    .btn.success {
      background: #48bb78;
      color: white;
    }

    .btn.warning {
      background: #ecc94b;
      color: #2d3748;
    }

    .btn.danger {
      background: #f56565;
      color: white;
    }

    .btn.info {
      background: #4299e1;
      color: white;
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(26, 32, 44, 0.7);
      z-index: 1000;
      backdrop-filter: blur(4px);
    }

    .modal-content {
      background: white;
      margin: 3vh auto;
      padding: 40px;
      width: 90%;
      max-width: 1200px;
      border-radius: 12px;
      max-height: 94vh;
      overflow-y: auto;
      box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
    }

    form {
      margin-top: 25px;
    }

    label {
      display: block;
      margin: 15px 0 8px 0;
      font-weight: 600;
      color: #2d3748;
      font-size: 0.95em;
    }

    input,
    textarea,
    select {
      width: 100%;
      padding: 12px;
      border: 1px solid #e2e8f0;
      border-radius: 6px;
      font-size: 15px;
      transition: border-color 0.2s, box-shadow 0.2s;
      background: #f8fafc;
    }

    input:focus,
    textarea:focus,
    select:focus {
      outline: none;
      border-color: #33bdef;
      background: white;
      box-shadow: 0 0 0 3px rgba(51, 189, 239, 0.1);
    }

    textarea {
      min-height: 120px;
      font-family: 'Consolas', 'Monaco', monospace;
      line-height: 1.6;
    }

    .form-row {
      margin-bottom: 20px;
    }

    .form-row.half {
      width: 49%;
      display: inline-block;
      margin-right: 2%;
      vertical-align: top;
    }

    .form-row.half:last-child {
      margin-right: 0;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 25px;
      margin: 30px 0;
    }

    .stat-card {
      background: white;
      padding: 30px;
      border-radius: 12px;
      text-align: center;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.02);
      border: 1px solid #e1e4e8;
      transition: transform 0.2s;
      cursor: pointer;
    }

    .stat-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 15px rgba(0, 0, 0, 0.05);
    }

    .stat-number {
      font-size: 2.5em;
      font-weight: 700;
      color: #33bdef;
      margin-bottom: 5px;
    }

    .stat-label {
      color: #718096;
      font-weight: 500;
    }

    .recent-activity {
      background: white;
      padding: 25px;
      border-radius: 12px;
      margin: 30px 0;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.02);
      border: 1px solid #e1e4e8;
    }

    .activity-item {
      padding: 12px 0;
      border-bottom: 1px solid #f0f4f8;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .activity-item:last-child {
      border-bottom: none;
    }

    .badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 0.75em;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .badge.blog {
      background: #c6f6d5;
      color: #22543d;
    }

    .badge.hub {
      background: #feebc8;
      color: #744210;
    }

    .badge.author {
      background: #bee3f8;
      color: #2a4365;
    }

    .badge.notification {
      background: #fed7d7;
      color: #742a2a;
    }

    .loading-spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid #f3f3f3;
      border-top: 3px solid #33bdef;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% {
        transform: rotate(0deg);
      }

      100% {
        transform: rotate(360deg);
      }
    }

    .error-message {
      background: #fed7d7;
      color: #742a2a;
      padding: 15px;
      border-radius: 8px;
      margin: 20px 0;
    }

    .success-message {
      background: #c6f6d5;
      color: #22543d;
      padding: 15px;
      border-radius: 8px;
      margin: 20px 0;
    }

    .slug-preview {
      font-size: 0.85em;
      color: #718096;
      margin-top: 5px;
      font-family: monospace;
    }

    /* SimpleMDE overrides */
    .CodeMirror {
      min-height: 300px;
      border: 1px solid #e2e8f0;
      border-radius: 6px;
    }

    .editor-toolbar {
      border: 1px solid #e2e8f0;
      border-bottom: none;
      border-radius: 6px 6px 0 0;
    }

    /* Blog search/filter/sort toolbar */
    .blog-toolbar {
      background: white;
      padding: 20px;
      border-radius: 10px;
      margin-bottom: 20px;
      border: 1px solid #e2e8f0;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.02);
    }

    .blog-toolbar-row {
      display: flex;
      gap: 12px;
      align-items: center;
      flex-wrap: wrap;
    }

    .blog-toolbar input[type="text"] {
      flex: 1;
      min-width: 200px;
      padding: 10px 14px;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      font-size: 14px;
      background: #f8fafc;
      transition: border-color 0.2s, box-shadow 0.2s;
    }

    .blog-toolbar input[type="text"]:focus {
      outline: none;
      border-color: #33bdef;
      box-shadow: 0 0 0 3px rgba(51, 189, 239, 0.1);
      background: white;
    }

    .blog-toolbar select {
      padding: 10px 14px;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      font-size: 14px;
      background: #f8fafc;
      cursor: pointer;
      min-width: 150px;
    }

    .blog-toolbar .result-count {
      font-size: 0.85em;
      color: #718096;
      margin-top: 10px;
    }

    /* Media insert panel (injected below SimpleMDE toolbar) */
    .media-insert-panel {
      background: #f8fafc;
      border: 1px solid #e2e8f0;
      border-top: none;
      border-radius: 0 0 8px 8px;
      padding: 16px;
      margin-bottom: 8px;
      animation: mediaPanelSlideDown 0.2s ease-out;
    }

    @keyframes mediaPanelSlideDown {
      from {
        opacity: 0;
        transform: translateY(-8px);
        max-height: 0;
      }

      to {
        opacity: 1;
        transform: translateY(0);
        max-height: 400px;
      }
    }

    .media-insert-panel .mip-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 12px;
    }

    .media-insert-panel .mip-header h4 {
      margin: 0;
      font-size: 0.95em;
      color: #1e293b;
    }

    .media-insert-panel .mip-close {
      background: none;
      border: none;
      font-size: 18px;
      cursor: pointer;
      color: #94a3b8;
      padding: 2px 6px;
      border-radius: 4px;
      transition: background 0.15s;
    }

    .media-insert-panel .mip-close:hover {
      background: #e2e8f0;
      color: #334155;
    }

    .media-insert-panel .mip-tabs {
      display: flex;
      gap: 0;
      margin-bottom: 14px;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      overflow: hidden;
    }

    .media-insert-panel .mip-tab {
      flex: 1;
      padding: 8px 12px;
      border: none;
      background: white;
      cursor: pointer;
      font-size: 0.85em;
      font-weight: 600;
      color: #64748b;
      transition: all 0.15s;
      text-align: center;
    }

    .media-insert-panel .mip-tab:not(:last-child) {
      border-right: 1px solid #e2e8f0;
    }

    .media-insert-panel .mip-tab.active {
      background: #33bdef;
      color: white;
    }

    .media-insert-panel .mip-tab:hover:not(.active) {
      background: #f1f5f9;
    }

    .media-insert-panel .mip-body {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .media-insert-panel .mip-row {
      display: flex;
      gap: 10px;
      align-items: center;
    }

    .media-insert-panel .mip-row.full {
      flex-direction: column;
      align-items: stretch;
    }

    .media-insert-panel input[type="text"],
    .media-insert-panel select {
      padding: 9px 12px;
      border: 1px solid #e2e8f0;
      border-radius: 6px;
      font-size: 13px;
      background: white;
      transition: border-color 0.15s, box-shadow 0.15s;
    }

    .media-insert-panel input[type="text"]:focus,
    .media-insert-panel select:focus {
      outline: none;
      border-color: #33bdef;
      box-shadow: 0 0 0 3px rgba(51, 189, 239, 0.1);
    }

    .media-insert-panel input[type="text"] {
      flex: 1;
      min-width: 0;
    }

    .media-insert-panel .mip-upload-zone {
      border: 2px dashed #cbd5e1;
      border-radius: 8px;
      padding: 20px;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
      background: white;
    }

    .media-insert-panel .mip-upload-zone:hover {
      border-color: #33bdef;
      background: #f0f9ff;
    }

    .media-insert-panel .mip-upload-zone.dragging {
      border-color: #33bdef;
      background: #e0f2fe;
    }

    .media-insert-panel .mip-upload-zone .upload-icon {
      font-size: 28px;
      margin-bottom: 6px;
    }

    .media-insert-panel .mip-upload-zone .upload-text {
      font-size: 0.85em;
      color: #64748b;
    }

    .media-insert-panel .mip-upload-zone .upload-hint {
      font-size: 0.75em;
      color: #94a3b8;
      margin-top: 4px;
    }

    .media-insert-panel .mip-upload-progress {
      margin-top: 8px;
      padding: 10px 14px;
      border-radius: 6px;
      font-size: 0.85em;
      display: none;
    }

    .media-insert-panel .mip-actions {
      display: flex;
      gap: 8px;
      justify-content: flex-end;
      margin-top: 4px;
    }

    .media-insert-panel .mip-actions .btn {
      padding: 8px 18px;
      font-size: 0.85em;
    }

    @media (max-width: 1024px) {
      .cms-sidebar {
        width: 80px;
        padding: 20px 10px;
      }

      .cms-nav-item {
        text-align: center;
        padding: 15px 5px;
        font-size: 1.5em;
      }

      .cms-sidebar h3 {
        display: none;
      }

      .cms-main {
        margin-left: 80px;
        padding: 20px;
      }
    }

    @media (max-width: 768px) {
      .cms-sidebar {
        display: none;
      }

      .cms-main {
        margin-left: 0;
        padding: 15px;
      }

      .stats-grid {
        grid-template-columns: 1fr;
      }

      .form-row.half {
        width: 100%;
        margin-right: 0;
      }

      .modal-content {
        width: 95%;
        margin: 10px auto;
        padding: 20px;
      }
    }
  </style>
</head>

<body>
  <nav class="cms-sidebar">
    <h3>üìä Dashboard</h3>
    <a href="#" class="cms-nav-item active" onclick="showSection('overview'); return false;">Overview</a>
    <a href="#" class="cms-nav-item" onclick="showSection('blog'); return false;">üìù Blog Posts</a>
    <a href="#" class="cms-nav-item" onclick="showSection('hubs'); return false;">üîó Content Hubs</a>
    <a href="#" class="cms-nav-item" onclick="showSection('authors'); return false;">üë• Authors</a>
    <a href="#" class="cms-nav-item" onclick="showSection('notifications'); return false;">üîî Notifications</a>
    <a href="#" class="cms-nav-item" onclick="showSection('pages'); return false;">üìÑ Pages</a>
    <a href="#" class="cms-nav-item" onclick="showSection('media'); return false;">üñºÔ∏è Media</a>
    <a href="#" class="cms-nav-item" onclick="showSection('analytics'); return false;">üìà Analytics</a>
  </nav>

  <main class="cms-main">
    <section id="overview" class="content-section active">
      <h1>üìä Content Management Dashboard</h1>
      <p>Complete control over your EvolvedLotus blog and content</p>

      <div class="stats-grid">
        <div class="stat-card" onclick="showSection('blog')">
          <div class="stat-number" id="statBlogPosts">0</div>
          <div class="stat-label">Blog Posts</div>
        </div>
        <div class="stat-card" onclick="showSection('hubs')">
          <div class="stat-number" id="statHubs">0</div>
          <div class="stat-label">Content Hubs</div>
        </div>
        <div class="stat-card" onclick="showSection('authors')">
          <div class="stat-number" id="statAuthors">0</div>
          <div class="stat-label">Authors</div>
        </div>
        <div class="stat-card">
          <div class="stat-number">1K+</div>
          <div class="stat-label">Monthly Visitors</div>
        </div>
      </div>

      <div class="recent-activity">
        <h3>üïê Recent Activity</h3>
        <div id="recentActivityList">
          <div class="activity-item">
            <span class="badge blog">Blog</span> <span id="lastUpdated">Loading...</span>
          </div>
        </div>
      </div>
    </section>

    <section id="blog" class="content-section">
      <h1>üìù Blog Posts Management</h1>
      <div style="margin: 20px 0;">
        <button class="btn primary" onclick="createNewContent('blog')">+ New Blog Post</button>
        <button class="btn" onclick="refreshSection('blog')">üîÑ Refresh</button>
      </div>
      <div class="blog-toolbar">
        <div class="blog-toolbar-row">
          <input type="text" id="blogSearchInput" placeholder="üîç Search posts by title, author, or tags..."
            oninput="filterBlogPosts()">
          <select id="blogFilterCategory" onchange="filterBlogPosts()">
            <option value="">All Categories</option>
            <option value="content-creation">Content Creation</option>
            <option value="social-media">Social Media</option>
            <option value="seo">SEO</option>
            <option value="analytics">Analytics</option>
            <option value="tools">Tools & Resources</option>
          </select>
          <select id="blogFilterStatus" onchange="filterBlogPosts()">
            <option value="">All Status</option>
            <option value="featured">Featured</option>
            <option value="draft">Draft</option>
            <option value="published">Published</option>
          </select>
          <select id="blogSortBy" onchange="filterBlogPosts()">
            <option value="date-desc">Newest First</option>
            <option value="date-asc">Oldest First</option>
            <option value="title-asc">Title A ‚Üí Z</option>
            <option value="title-desc">Title Z ‚Üí A</option>
            <option value="author-asc">Author A ‚Üí Z</option>
          </select>
        </div>
        <div class="result-count" id="blogResultCount"></div>
      </div>
      <div id="blogList" class="content-list">
        <p><span class="loading-spinner"></span> Loading blog posts...</p>
      </div>
    </section>

    <section id="hubs" class="content-section">
      <h1>üîó Content Hubs Management</h1>
      <div style="margin: 20px 0;">
        <button class="btn primary" onclick="createNewContent('hub')">+ New Hub Content</button>
        <button class="btn" onclick="refreshSection('hubs')">üîÑ Refresh</button>
      </div>
      <div id="hubsList" class="content-list">
        <p><span class="loading-spinner"></span> Loading content hubs...</p>
      </div>
    </section>

    <section id="authors" class="content-section">
      <h1>üë• Authors Management</h1>
      <div style="margin: 20px 0;">
        <button class="btn primary" onclick="createNewContent('author')">+ New Author</button>
        <button class="btn" onclick="refreshSection('authors')">üîÑ Refresh</button>
      </div>
      <div id="authorsList" class="content-list">
        <p><span class="loading-spinner"></span> Loading authors...</p>
      </div>
    </section>

    <section id="notifications" class="content-section">
      <h1>üîî Notifications Management</h1>
      <div style="margin: 20px 0;">
        <button class="btn primary" onclick="createNewContent('notification')">+ New Notification</button>
        <button class="btn" onclick="refreshSection('notifications')">üîÑ Refresh</button>
      </div>
      <div id="notificationsList" class="content-list">
        <p><span class="loading-spinner"></span> Loading notifications...</p>
      </div>
    </section>

    <section id="pages" class="content-section">
      <h1>üìÑ Pages Management</h1>
      <div style="margin: 20px 0;">
        <button class="btn primary" onclick="createNewContent('page')">+ New Page</button>
        <button class="btn" onclick="refreshSection('pages')">üîÑ Refresh</button>
      </div>
      <div id="pagesList" class="content-list">
        <p><span class="loading-spinner"></span> Loading pages...</p>
      </div>
    </section>

    <section id="media" class="content-section">
      <h1>üñºÔ∏è Media Management</h1>
      <div style="margin: 20px 0;">
        <button class="btn primary" onclick="createNewContent('media')">+ Upload Media</button>
        <button class="btn" onclick="refreshSection('media')">üîÑ Refresh</button>
      </div>
      <div id="mediaList" class="content-list">
        <p><span class="loading-spinner"></span> Loading media files...</p>
      </div>
    </section>

    <section id="analytics" class="content-section">
      <h1>üìà Content Analytics</h1>
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-number">2.4K</div>
          <div class="stat-label">Page Views (Today)</div>
        </div>
        <div class="stat-card">
          <div class="stat-number">45</div>
          <div class="stat-label">Hours Read (Today)</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="analyticsPostCount">0</div>
          <div class="stat-label">Articles Published (This Month)</div>
        </div>
        <div class="stat-card">
          <div class="stat-number">89%</div>
          <div class="stat-label">Search Satisfaction</div>
        </div>
      </div>
    </section>


  </main>

  <!-- Content Editor Modal -->
  <div id="editModal" class="modal">
    <div class="modal-content">
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <h2 id="modalTitle" style="margin:0;">Content Editor</h2>
        <button onclick="closeModal()"
          style="background:none; border:none; font-size:1.5em; cursor:pointer;">&times;</button>
      </div>
      <form id="contentForm" novalidate>
        <input type="hidden" id="contentType">

        <!-- üìù BLOG POST FIELDS -->
        <div id="blogFields" class="form-section">
          <div style="display:flex; justify-content:flex-end; margin-bottom:15px;">
            <button type="button" class="btn success" id="btnGenerateSEO" onclick="generateSEO()"
              style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border:none; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
              ‚ú® Auto-Fill SEO with AI
            </button>
          </div>
          <div class="form-row">
            <label for="blogTitle">Post Title:</label>
            <input type="text" id="blogTitle" placeholder="10 Tips for..." oninput="updateSlug('blog')">
            <div class="slug-preview" id="blogSlugPreview"></div>
          </div>
          <div class="form-row">
            <label for="blogDesc">Description (SEO):</label>
            <textarea id="blogDesc" rows="2"></textarea>
          </div>
          <div class="form-row half">
            <label for="blogDate">Publish Date:</label>
            <input type="datetime-local" id="blogDate">
          </div>
          <div class="form-row half">
            <label for="blogAuthor">Author:</label>
            <select id="blogAuthor">
              <option value="EvolvedLotus Team">EvolvedLotus Team</option>
            </select>
          </div>
          <div class="form-row">
            <label for="blogTags">Tags (comma-separated):</label>
            <input type="text" id="blogTags" placeholder="marketing, guide, 2024">
          </div>
          <div class="form-row half">
            <label for="blogCategory">Category:</label>
            <select id="blogCategory">
              <option value="">Select Category</option>
              <option value="content-creation">Content Creation</option>
              <option value="social-media">Social Media</option>
              <option value="seo">SEO</option>
              <option value="analytics">Analytics</option>
              <option value="tools">Tools & Resources</option>
            </select>
          </div>
          <div class="form-row half">
            <div class="form-row half">
              <label>Featured Image:</label>
              <input type="hidden" id="blogImage">

              <div id="blogImageDropZone"
                style="border: 2px dashed #e2e8f0; padding: 15px; text-align:center; border-radius:6px; cursor:pointer; background: #f8fafc; transition: all 0.2s;"
                onclick="document.getElementById('blogImageInput').click()"
                ondragover="event.preventDefault(); this.style.borderColor='#33bdef'; this.style.background='#e0f2fe';"
                ondragleave="this.style.borderColor='#e2e8f0'; this.style.background='#f8fafc';"
                ondrop="event.preventDefault(); this.style.borderColor='#e2e8f0'; this.style.background='#f8fafc'; handleBlogImageDrop(event);">
                <p style="margin:0; font-size: 0.9em; color:#64748b;">üìÇ Click to upload</p>
                <small style="display:block; margin-top:5px; color:#94a3b8; font-size:0.75em;">
                  Recommendation size is how the REST of the images in the article-hero-image are sized
                </small>
              </div>
              <input type="file" id="blogImageInput" accept="image/*" style="display:none;"
                onchange="handleBlogImageUpload(event)">

              <div id="blogImagePreview"
                style="display:none; margin-top:10px; align-items:center; gap:10px; background: white; padding: 5px; border: 1px solid #eee; border-radius: 6px;">
                <img id="blogImagePreviewImg" src=""
                  style="width:50px; height:35px; object-fit:cover; border-radius:4px;">
                <div
                  style="flex-grow:1; font-size:0.75em; color:#64748b; overflow:hidden; text-overflow:ellipsis; white-space: nowrap; max-width: 150px;"
                  id="blogImagePathDisplay"></div>
                <button type="button" class="btn danger" style="padding:2px 6px; font-size:0.7em; margin:0;"
                  onclick="removeBlogImage()">√ó</button>
              </div>
            </div>
          </div>
          <div class="form-row">
            <label><input type="checkbox" id="blogFeatured"> Featured</label>
            <label style="margin-left:15px;"><input type="checkbox" id="blogDraft"> Draft</label>
          </div>


          <h4 style="border-bottom:1px solid #eee; padding-bottom:5px; margin-top:20px;">SEO Advanced</h4>
          <div class="form-row"><input type="text" id="blogImageAlt" placeholder="Image Alt Text"></div>
          <div class="form-row"><input type="text" id="blogKeywords" placeholder="Keywords (comma sep)"></div>
          <div class="form-row half">
            <select id="blogSchema">
              <option value="Article">Article Schema</option>
              <option value="BlogPosting">BlogPosting</option>
            </select>
          </div>
          <div class="form-row half">
            <select id="blogOg">
              <option value="article">OG: Article</option>
              <option value="website">OG: Website</option>
            </select>
          </div>
        </div>

        <!-- üîó HUB FIELDS -->
        <div id="hubFields" class="form-section">
          <div class="form-row">
            <label for="hubTitle">Hub Title:</label>
            <input type="text" id="hubTitle" oninput="updateSlug('hub')">
            <div class="slug-preview" id="hubSlugPreview"></div>
          </div>
          <div class="form-row">
            <label for="hubDesc">Description:</label>
            <textarea id="hubDesc" rows="3"></textarea>
          </div>
          <div class="form-row">
            <label for="hubCollection">Hub Collection Strategy:</label>
            <select id="hubCollection">
              <option value="tiktok">TikTok (tiktok)</option>
              <option value="instagram">Instagram (instagram)</option>
              <option value="youtube">YouTube (youtube)</option>
              <option value="ai">AI Tools (ai)</option>
            </select>
          </div>
          <div class="form-row">
            <label for="hubPermalink">Permalink:</label>
            <input type="text" id="hubPermalink" placeholder="/hubs/my-topic/">
          </div>
        </div>

        <!-- üë• AUTHOR FIELDS -->
        <div id="authorFields" class="form-section">
          <div class="form-row half">
            <label for="authorName">Full Name:</label>
            <input type="text" id="authorName" oninput="updateSlug('author')">
            <div class="slug-preview" id="authorSlugPreview"></div>
          </div>
          <div class="form-row half">
            <label for="authorRole">Role:</label>
            <input type="text" id="authorRole">
          </div>
          <div class="form-row">
            <label for="authorBio">Bio:</label>
            <textarea id="authorBio" rows="3"></textarea>
          </div>
          <div class="form-row">
            <label for="authorAvatar">Avatar URL:</label>
            <input type="text" id="authorAvatar" placeholder="/assets/authors/name.png">
          </div>
          <div class="form-row">
            <label>Social Media Links:</label>
            <input type="url" id="authorTwitter" placeholder="Twitter URL" style="margin-bottom:5px;">
            <input type="url" id="authorInsta" placeholder="Instagram URL" style="margin-bottom:5px;">
            <input type="url" id="authorTiktok" placeholder="TikTok URL">
          </div>
          <div class="form-row">
            <label for="authorExpertise">Expertise (One per line):</label>
            <textarea id="authorExpertise" rows="4"></textarea>
          </div>
        </div>

        <!-- üîî NOTIFICATION FIELDS -->
        <div id="notificationFields" class="form-section">
          <div class="form-row">
            <label for="notifTitle">Title:</label>
            <input type="text" id="notifTitle" oninput="updateSlug('notification')">
            <div class="slug-preview" id="notificationSlugPreview"></div>
          </div>
          <div class="form-row">
            <label for="notifDate">Date:</label>
            <input type="date" id="notifDate">
          </div>
          <div class="form-row">
            <label for="notifLink">Link (Optional):</label>
            <input type="url" id="notifLink">
          </div>
          <div class="form-row">
            <label for="notifTags">Tags:</label>
            <input type="text" id="notifTags" value="notification" placeholder="notification, alert">
          </div>
        </div>

        <!-- üìÑ PAGE FIELDS -->
        <div id="pageFields" class="form-section">
          <div class="form-row">
            <label for="pageTitle">Page Title:</label>
            <input type="text" id="pageTitle" oninput="updateSlug('page')">
            <div class="slug-preview" id="pageSlugPreview"></div>
          </div>
          <div class="form-row">
            <label for="pageLayout">Layout:</label>
            <input type="text" id="pageLayout" value="page.njk">
          </div>
          <div class="form-row">
            <label for="pagePermalink">Permalink:</label>
            <input type="text" id="pagePermalink" placeholder="/my-page/">
          </div>
        </div>

        <!-- üñºÔ∏è MEDIA FIELDS -->
        <div id="mediaFields" class="form-section">
          <div class="form-row">
            <label>Select Image to Upload:</label>
            <input type="file" id="mediaFileInput" accept="image/*" onchange="handleMediaFileSelect(event)"
              style="display:none;">
            <div id="mediaDropZone"
              style="border: 2px dashed #33bdef; padding: 40px; text-align:center; border-radius:8px; cursor:pointer; background: #f9fbfc; transition: all 0.3s;"
              onclick="document.getElementById('mediaFileInput').click()"
              ondragover="event.preventDefault(); this.style.borderColor='#0ea5e9'; this.style.background='#e0f2fe';"
              ondragleave="this.style.borderColor='#33bdef'; this.style.background='#f9fbfc';"
              ondrop="event.preventDefault(); this.style.borderColor='#33bdef'; this.style.background='#f9fbfc'; handleMediaFileDrop(event);">
              <p style="margin:0; font-size:18px;">üìÇ Drag and drop image here or click to browse</p>
              <small style="color:#666;">Supports: JPG, PNG, GIF, WebP (Max 5MB)</small>
            </div>
          </div>
          <div class="form-row" id="mediaPreviewRow" style="display:none;">
            <label>Preview:</label>
            <div style="display:flex; gap:20px; align-items:flex-start;">
              <img id="mediaPreview"
                style="max-width:200px; max-height:200px; border-radius:8px; border:1px solid #ddd;">
              <div>
                <p><strong>File:</strong> <span id="mediaFileName"></span></p>
                <p><strong>Size:</strong> <span id="mediaFileSize"></span></p>
                <p><strong>Path:</strong> <code>/assets/images/<span id="mediaFilePath"></span></code></p>
              </div>
            </div>
          </div>
          <div class="form-row" id="mediaUploadRow" style="display:none;">
            <button type="button" class="btn primary" onclick="uploadMediaFile()">üì§ Upload to Repository</button>
            <button type="button" class="btn" onclick="clearMediaUpload()">Cancel</button>
          </div>
          <div id="mediaUploadStatus" style="display:none; padding: 15px; border-radius: 8px; margin-top: 10px;"></div>
        </div>

        <!-- COMMON CONTENT TEXTAREA (Shared by Blog, Hub, Page, Notif) -->
        <div class="form-row" id="commonContentRow">
          <label for="mainContent">Body Content (Markdown):</label>
          <textarea id="mainContent"></textarea>
        </div>

        <div class="form-row">
          <button type="submit" class="btn primary" id="saveBtn">Save Changes</button>
          <button type="button" class="btn info" onclick="generateFrontmatterProto()">Copy Code Only</button>
          <button type="button" class="btn" onclick="closeModal()">Cancel</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    let currentSection = 'overview';
    let contentData = {};
    let simpleMDE = null;
    let editingItemId = null; // Track the ID of item being edited (null = new content)
    let selectedMediaFile = null; // Track selected media file for upload

    // Media upload functions
    function handleMediaFileSelect(e) {
      const file = e.target.files[0];
      if (file) processMediaFile(file);
    }

    function handleMediaFileDrop(e) {
      const file = e.dataTransfer.files[0];
      if (file) processMediaFile(file);
    }

    function processMediaFile(file) {
      // Validate file type
      if (!file.type.startsWith('image/')) {
        alert('‚ùå Please select an image file (JPG, PNG, GIF, WebP)');
        return;
      }

      // Validate file size (5MB max)
      if (file.size > 5 * 1024 * 1024) {
        alert('‚ùå File size must be less than 5MB');
        return;
      }

      selectedMediaFile = file;

      // Show preview
      const reader = new FileReader();
      reader.onload = (e) => {
        document.getElementById('mediaPreview').src = e.target.result;
        document.getElementById('mediaPreviewRow').style.display = 'block';
        document.getElementById('mediaUploadRow').style.display = 'block';
      };
      reader.readAsDataURL(file);

      // Update info
      const sanitizedName = file.name.toLowerCase().replace(/[^a-z0-9.-]/g, '-');
      document.getElementById('mediaFileName').textContent = file.name;
      document.getElementById('mediaFileSize').textContent = formatFileSize(file.size);
      document.getElementById('mediaFilePath').textContent = sanitizedName;
    }

    function formatFileSize(bytes) {
      if (bytes < 1024) return bytes + ' B';
      if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
      return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
    }

    function clearMediaUpload() {
      selectedMediaFile = null;
      document.getElementById('mediaFileInput').value = '';
      document.getElementById('mediaPreviewRow').style.display = 'none';
      document.getElementById('mediaUploadRow').style.display = 'none';
      document.getElementById('mediaUploadStatus').style.display = 'none';
    }

    async function uploadMediaFile() {
      if (!selectedMediaFile) {
        alert('No file selected');
        return;
      }

      const statusEl = document.getElementById('mediaUploadStatus');
      statusEl.style.display = 'block';
      statusEl.style.background = '#e0f2fe';
      statusEl.innerHTML = '‚è≥ Uploading image to repository...';

      try {
        // Convert file to base64
        const base64Content = await new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = () => resolve(reader.result.split(',')[1]); // Remove data URL prefix
          reader.onerror = reject;
          reader.readAsDataURL(selectedMediaFile);
        });

        const sanitizedName = selectedMediaFile.name.toLowerCase().replace(/[^a-z0-9.-]/g, '-');
        const filePath = `assets/images/${sanitizedName}`;

        // Upload via Netlify function
        const response = await fetch('/.netlify/functions/save-content', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            filename: filePath,
            content: base64Content,
            type: 'Media',
            action: 'upload-binary',
            isBase64: true
          })
        });

        const result = await response.json();

        if (response.ok && result.success) {
          statusEl.style.background = '#d1fae5';
          statusEl.innerHTML = `‚úÖ Image uploaded successfully!<br><br>
            <strong>Path:</strong> <code>/assets/images/${sanitizedName}</code><br>
            <button class="btn" onclick="navigator.clipboard.writeText('/assets/images/${sanitizedName}').then(() => alert('Path copied!'))">üìã Copy Path</button>`;

          // Clear the file input
          document.getElementById('mediaFileInput').value = '';
          selectedMediaFile = null;
        } else {
          throw new Error(result.message || result.error || 'Upload failed');
        }
      } catch (error) {
        console.error('Upload error:', error);
        statusEl.style.background = '#fee2e2';
        statusEl.innerHTML = `‚ùå Upload failed: ${error.message}`;
      }
    }


    // Initialize SimpleMDE when modal opens
    function initializeEditor() {
      if (!simpleMDE) {
        simpleMDE = new SimpleMDE({
          element: document.getElementById("mainContent"),
          spellChecker: false,
          placeholder: "Write your content here using Markdown...",
          status: ["lines", "words", "cursor"],
          toolbar: [
            "bold", "italic", "heading", "|",
            "quote", "unordered-list", "ordered-list", "|",
            "link", "image", "|",
            {
              name: "insert-image-block",
              action: function (editor) { toggleMediaPanel('image'); },
              className: "fa fa-picture-o",
              title: "Insert Image Block (with aspect ratio)"
            },
            {
              name: "insert-video-block",
              action: function (editor) { toggleMediaPanel('video'); },
              className: "fa fa-video-camera",
              title: "Insert Video Block (YouTube, file, etc.)"
            },
            {
              name: "upload-file",
              action: function (editor) { toggleMediaPanel('upload'); },
              className: "fa fa-upload",
              title: "Upload file from PC"
            },
            "|",
            "preview", "side-by-side", "fullscreen", "|", "guide"
          ],
          forceSync: true,
          autoDownloadFontAwesome: false
        });
      }
    }

    // Auto-slug generation
    function updateSlug(type) {
      let title = '';
      let previewId = '';

      if (type === 'blog') {
        title = document.getElementById('blogTitle').value;
        previewId = 'blogSlugPreview';
      } else if (type === 'hub') {
        title = document.getElementById('hubTitle').value;
        previewId = 'hubSlugPreview';
      } else if (type === 'author') {
        title = document.getElementById('authorName').value;
        previewId = 'authorSlugPreview';
      } else if (type === 'notification') {
        title = document.getElementById('notifTitle').value;
        previewId = 'notificationSlugPreview';
      } else if (type === 'page') {
        title = document.getElementById('pageTitle').value;
        previewId = 'pageSlugPreview';
      }

      const slug = title.toLowerCase()
        .replace(/[^a-z0-9]+/g, '-')
        .replace(/^-+|-+$/g, '');

      const previewEl = document.getElementById(previewId);
      if (previewEl) {
        previewEl.textContent = slug ? `Slug: ${slug}` : '';
      }
    }

    function showSection(name) {
      document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));
      document.querySelectorAll('.cms-nav-item').forEach(i => i.classList.remove('active'));
      document.getElementById(name).classList.add('active');
      event.target.classList.add('active');
      currentSection = name;

      // Load section data if not already loaded
      if (name === 'blog' && !contentData.blogLoaded) loadBlogPosts();
      if (name === 'hubs' && !contentData.hubsLoaded) loadHubContent();
      if (name === 'authors' && !contentData.authorsLoaded) loadAuthors();
      if (name === 'notifications' && !contentData.notificationsLoaded) loadNotifications();
      if (name === 'pages' && !contentData.pagesLoaded) loadPages();
      if (name === 'media' && !contentData.mediaLoaded) loadMedia();

    }

    function refreshSection(sec) {
      if (sec === 'blog') { contentData.blogLoaded = false; loadBlogPosts(); }
      if (sec === 'hubs') { contentData.hubsLoaded = false; loadHubContent(); }
      if (sec === 'authors') { contentData.authorsLoaded = false; loadAuthors(); }
      if (sec === 'notifications') { contentData.notificationsLoaded = false; loadNotifications(); }
      if (sec === 'pages') { contentData.pagesLoaded = false; loadPages(); }
      if (sec === 'media') { contentData.mediaLoaded = false; loadMedia(); }
    }

    async function loadContentData() {
      try {
        console.log('Fetching from /api/posts.json...');
        const res = await fetch('/api/posts.json');
        console.log('Response status:', res.status);
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const rawText = await res.text();
        console.log('Raw response:', rawText.substring(0, 500) + '...');
        const data = JSON.parse(rawText);
        console.log('Successfully parsed data:', Object.keys(data));
        if (data.blog && data.blog.length > 0) {
          console.log('First blog post keys:', Object.keys(data.blog[0]));
          console.log('First blog post title:', data.blog[0].title);
          console.log('First blog post body length:', data.blog[0].body?.length || 'No body', 'is body undefined:', data.blog[0].body === undefined);
        }
        contentData = { ...contentData, ...data };

        // Update dashboard stats
        if (data.stats) {
          document.getElementById('statBlogPosts').textContent = data.stats.totalBlogPosts || 0;
          document.getElementById('statHubs').textContent = data.stats.totalHubs || 0;
          document.getElementById('statAuthors').textContent = data.stats.totalAuthors || 0;
          document.getElementById('lastUpdated').textContent = `Last updated: ${data.stats.lastUpdated || 'Unknown'}`;
        }

        // Update analytics
        if (data.blog) {
          const thisMonth = data.blog.filter(p => {
            const postDate = new Date(p.date);
            const now = new Date();
            return postDate.getMonth() === now.getMonth() && postDate.getFullYear() === now.getFullYear();
          });
          document.getElementById('analyticsPostCount').textContent = thisMonth.length;
        }

        // Populate author dropdown
        if (data.authors && data.authors.length > 0) {
          const authorSelect = document.getElementById('blogAuthor');
          authorSelect.innerHTML = '<option value="EvolvedLotus Team">EvolvedLotus Team</option>';
          data.authors.forEach(author => {
            const option = document.createElement('option');
            option.value = author.name;
            option.textContent = author.name;
            authorSelect.appendChild(option);
          });
        }

        return data;
      } catch (e) {
        console.error('Error loading content data:', e);
        document.getElementById('lastUpdated').textContent = 'Error loading data';
        return null;
      }
    }

    // Loaders with error handling
    function loadBlogPosts() {
      contentData.blogLoaded = true;
      filterBlogPosts();
    }

    function filterBlogPosts() {
      const listEl = document.getElementById('blogList');
      const countEl = document.getElementById('blogResultCount');
      try {
        let posts = contentData.blog || [];
        const totalCount = posts.length;

        if (posts.length === 0) {
          listEl.innerHTML = '<p>No posts found. Click "+ New Blog Post" to create your first post!</p>';
          if (countEl) countEl.textContent = '';
          return;
        }

        // Search filter
        const searchVal = (document.getElementById('blogSearchInput')?.value || '').toLowerCase().trim();
        if (searchVal) {
          posts = posts.filter(p => {
            const title = (p.title || '').toLowerCase();
            const author = (p.author || '').toLowerCase();
            const tags = (Array.isArray(p.tags) ? p.tags.join(' ') : (p.tags || '')).toLowerCase();
            const desc = (p.description || '').toLowerCase();
            return title.includes(searchVal) || author.includes(searchVal) || tags.includes(searchVal) || desc.includes(searchVal);
          });
        }

        // Category filter
        const catVal = document.getElementById('blogFilterCategory')?.value || '';
        if (catVal) {
          posts = posts.filter(p => (p.category || '') === catVal);
        }

        // Status filter
        const statusVal = document.getElementById('blogFilterStatus')?.value || '';
        if (statusVal === 'featured') {
          posts = posts.filter(p => p.featured);
        } else if (statusVal === 'draft') {
          posts = posts.filter(p => p.draft);
        } else if (statusVal === 'published') {
          posts = posts.filter(p => !p.draft);
        }

        // Sort
        const sortVal = document.getElementById('blogSortBy')?.value || 'date-desc';
        posts.sort((a, b) => {
          if (sortVal === 'date-desc') return new Date(b.date || 0) - new Date(a.date || 0);
          if (sortVal === 'date-asc') return new Date(a.date || 0) - new Date(b.date || 0);
          if (sortVal === 'title-asc') return (a.title || '').localeCompare(b.title || '');
          if (sortVal === 'title-desc') return (b.title || '').localeCompare(a.title || '');
          if (sortVal === 'author-asc') return (a.author || '').localeCompare(b.author || '');
          return 0;
        });

        // Update result count
        if (countEl) {
          if (searchVal || catVal || statusVal) {
            countEl.textContent = `Showing ${posts.length} of ${totalCount} posts`;
          } else {
            countEl.textContent = `${totalCount} total posts`;
          }
        }

        if (posts.length === 0) {
          listEl.innerHTML = '<p style="color:#718096;">No posts match your filters. Try adjusting your search or filters.</p>';
          return;
        }

        listEl.innerHTML = posts.map(p => `
          <div class="content-item">
            <h4>${p.title || 'Untitled'} ${p.featured ? '<span class="badge blog">FEATURED</span>' : ''} ${p.draft ? '<span class="badge notification">DRAFT</span>' : ''}</h4>
            <div class="content-meta">Published: ${p.date || 'No date'} | ${p.author || 'Unknown author'}</div>
            ${p.category ? `<div class="content-meta">Category: ${p.category}</div>` : ''}
            ${p.tags && p.tags.length ? `<div class="content-meta" style="margin-top:4px;">${(Array.isArray(p.tags) ? p.tags : [p.tags]).map(t => `<span style="display:inline-block;background:#edf2f7;padding:2px 8px;border-radius:12px;font-size:0.78em;margin:2px 3px 2px 0;">${t}</span>`).join('')}</div>` : ''}
            <div class="content-actions">
              <button class="btn info" onclick="editContent('blog','${p.id}')">Edit</button>
              <button class="btn success" onclick="viewContent('${p.url}')">View</button>
              <button class="btn danger" onclick="deleteContent('blog','${p.id}','${(p.title || 'Untitled').replace(/'/g, "\\'")}')">Delete</button>
            </div>
          </div>`).join('');
      } catch (e) {
        console.error('Error loading blog posts:', e);
        listEl.innerHTML = '<div class="error-message">Error loading blog posts. Please refresh the page.</div>';
      }
    }

    function loadHubContent() {
      const listEl = document.getElementById('hubsList');
      try {
        const hubs = contentData.hubs || [];
        contentData.hubsLoaded = true;

        if (hubs.length === 0) {
          listEl.innerHTML = '<p>No content hubs found. Click "+ New Hub Content" to create your first hub!</p>';
          return;
        }

        listEl.innerHTML = hubs.map(h => `
          <div class="content-item">
            <h4>${h.title || 'Untitled Hub'}</h4>
            <div class="content-meta">Platform: ${h.platform || 'Not specified'}</div>
            ${h.description ? `<div class="content-meta">${h.description}</div>` : ''}
            <div class="content-actions">
              <button class="btn info" onclick="editContent('hub','${h.id}')">Edit</button>
              <button class="btn success" onclick="viewContent('${h.url}')">View</button>
            </div>
          </div>`).join('');
      } catch (e) {
        console.error('Error loading hubs:', e);
        listEl.innerHTML = '<div class="error-message">Error loading content hubs. Please refresh the page.</div>';
      }
    }

    function loadAuthors() {
      const listEl = document.getElementById('authorsList');
      try {
        const auths = contentData.authors || [];
        contentData.authorsLoaded = true;

        if (auths.length === 0) {
          listEl.innerHTML = '<p>No authors found. Click "+ New Author" to create your first author profile!</p>';
          return;
        }

        listEl.innerHTML = auths.map(a => `
          <div class="content-item">
            <h4>${a.name || 'Unnamed Author'}</h4>
            <div class="content-meta">${a.role || 'No role specified'}</div>
            ${a.bio ? `<div class="content-meta">${a.bio.substring(0, 100)}${a.bio.length > 100 ? '...' : ''}</div>` : ''}
            <div class="content-actions">
              <button class="btn info" onclick="editContent('author','${a.id}')">Edit</button>
            </div>
          </div>`).join('');
      } catch (e) {
        console.error('Error loading authors:', e);
        listEl.innerHTML = '<div class="error-message">Error loading authors. Please refresh the page.</div>';
      }
    }

    function loadNotifications() {
      const listEl = document.getElementById('notificationsList');
      try {
        // Check if notifications collection exists
        const notifs = contentData.notifications || [];
        contentData.notificationsLoaded = true;

        if (notifs.length === 0) {
          listEl.innerHTML = '<p>No notifications found. Click "+ New Notification" to create your first notification!</p>';
          return;
        }

        listEl.innerHTML = notifs.map(n => `
          <div class="content-item">
            <h4>${n.title || 'Untitled Notification'}</h4>
            <div class="content-meta">Date: ${n.date || 'No date'}</div>
            <div class="content-actions">
              <button class="btn info" onclick="editContent('notification','${n.id}')">Edit</button>
            </div>
          </div>`).join('');
      } catch (e) {
        console.error('Error loading notifications:', e);
        listEl.innerHTML = '<div class="error-message">Error loading notifications. Please refresh the page.</div>';
      }
    }

    function loadPages() {
      const listEl = document.getElementById('pagesList');
      try {
        // Pages are typically static - list common ones
        const pages = contentData.pages || [];
        contentData.pagesLoaded = true;

        if (pages.length === 0) {
          listEl.innerHTML = `
            <p>Static pages are managed in the <code>src/pages/</code> directory.</p>
            <p>Common pages: About, Contact, Privacy Policy</p>
            <p>Click "+ New Page" to create a new static page!</p>
          `;
          return;
        }

        listEl.innerHTML = pages.map(p => `
          <div class="content-item">
            <h4>${p.title || 'Untitled Page'}</h4>
            <div class="content-meta">Layout: ${p.layout || 'page.njk'}</div>
            <div class="content-actions">
              <button class="btn info" onclick="editContent('page','${p.id}')">Edit</button>
              <button class="btn success" onclick="viewContent('${p.url}')">View</button>
            </div>
          </div>`).join('');
      } catch (e) {
        console.error('Error loading pages:', e);
        listEl.innerHTML = '<div class="error-message">Error loading pages. Please refresh the page.</div>';
      }
    }

    async function loadMedia() {
      const listEl = document.getElementById('mediaList');
      try {
        const r = await fetch('/api/media.json');
        if (!r.ok) throw new Error(`HTTP ${r.status}`);
        const d = await r.json();
        const list = d.media || [];
        contentData.mediaLoaded = true;

        if (list.length === 0) {
          listEl.innerHTML = '<p>No media files found. Click "+ Upload Media" to add images and files!</p>';
          return;
        }

        listEl.innerHTML = `<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(150px,1fr));gap:15px;">
            ${list.map(f => `<div class="content-item" style="text-align:center;padding:10px;">
              <img src="${f.path}" style="height:100px;width:100%;object-fit:cover;border-radius:6px;margin-bottom:8px;" alt="${f.name}">
              <div style="font-size:0.8em;overflow:hidden;text-overflow:ellipsis;margin-bottom:8px;">${f.name}</div>
              <button class="btn info" style="font-size:0.7em;padding:5px 10px;" onclick="navigator.clipboard.writeText('${f.path}');alert('URL copied to clipboard!')">Copy URL</button>
            </div>`).join('')}</div>`;
      } catch (e) {
        console.error('Error loading media:', e);
        listEl.innerHTML = '<div class="error-message">Error loading media files. Please refresh the page.</div>';
      }
    }

    // CREATE / EDIT
    function createNewContent(type) {
      document.getElementById('contentForm').reset();
      document.getElementById('contentType').value = type;
      document.getElementById('modalTitle').textContent = 'Create New ' + type.charAt(0).toUpperCase() + type.slice(1);
      editingItemId = null; // Reset - this is a new item

      // Hide all sections
      document.querySelectorAll('.form-section').forEach(el => el.classList.remove('active'));

      // Hide content row and action buttons for media (has its own upload button)
      const isMedia = (type === 'media');
      document.getElementById('commonContentRow').style.display = isMedia ? 'none' : 'block';
      document.getElementById('saveBtn').style.display = isMedia ? 'none' : 'inline-block';
      document.querySelector('button[onclick="generateFrontmatterProto()"]').style.display = isMedia ? 'none' : 'inline-block';

      // Clear media upload state
      if (isMedia) {
        clearMediaUpload();
      }

      // Show specific section
      if (type === 'blog') document.getElementById('blogFields').classList.add('active');
      if (type === 'hub') document.getElementById('hubFields').classList.add('active');
      if (type === 'author') document.getElementById('authorFields').classList.add('active');
      if (type === 'notification') document.getElementById('notificationFields').classList.add('active');
      if (type === 'page') document.getElementById('pageFields').classList.add('active');
      if (type === 'media') document.getElementById('mediaFields').classList.add('active');

      document.getElementById('editModal').style.display = 'block';

      // Initialize rich text editor
      if (type !== 'media') {
        setTimeout(() => initializeEditor(), 100);
      }

      // Defaults
      if (type === 'blog') {
        const now = new Date();
        now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
        document.getElementById('blogDate').value = now.toISOString().slice(0, 16);
      }
      if (type === 'notification') {
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('notifDate').value = today;
      }
    }

    function editContent(type, id) {
      createNewContent(type);
      document.getElementById('modalTitle').textContent = 'Edit ' + type.charAt(0).toUpperCase() + type.slice(1);

      // Map singular type names to plural data keys
      const typeToDataKey = {
        'blog': 'blog',
        'hub': 'hubs',
        'author': 'authors',
        'notification': 'notifications',
        'page': 'pages'
      };
      const dataKey = typeToDataKey[type] || type;
      const dataArray = contentData[dataKey];

      console.log('editContent called with type:', type, 'id:', id);
      console.log('Data key:', dataKey, 'Array exists:', !!dataArray, 'Array length:', dataArray?.length);

      const item = dataArray?.find(i => i.id === id);
      if (!item) {
        console.log('Item not found. Available IDs:', dataArray?.map(i => i.id));
        alert('Content not found');
        return;
      }
      console.log('Found item:', item);

      // Store the item ID for editing (so we update the same file)
      editingItemId = id;

      if (type === 'blog') {
        document.getElementById('blogTitle').value = item.title || '';
        document.getElementById('blogDesc').value = item.description || '';
        document.getElementById('blogDate').value = item.date + 'T12:00';
        document.getElementById('blogAuthor').value = item.author || 'EvolvedLotus Team';
        document.getElementById('blogTags').value = item.tags ? (Array.isArray(item.tags) ? item.tags.join(',') : item.tags) : '';
        document.getElementById('blogCategory').value = item.category || '';
        document.getElementById('blogImage').value = item.image || '';
        updateBlogImagePreview(item.image || '');
        document.getElementById('blogImageAlt').value = item.imageAlt || '';
        document.getElementById('blogKeywords').value = item.keywords || '';
        document.getElementById('blogSchema').value = item.schema_type || 'Article';
        document.getElementById('blogOg').value = item.og_type || 'article';
        document.getElementById('blogFeatured').checked = !!item.featured;
        document.getElementById('blogDraft').checked = !!item.draft;
        updateSlug('blog');
      }
      if (type === 'hub') {
        document.getElementById('hubTitle').value = item.title || '';
        document.getElementById('hubDesc').value = item.description || '';
        document.getElementById('hubCollection').value = item.platform || '';
        document.getElementById('hubPermalink').value = item.url || '';
        updateSlug('hub');
      }
      if (type === 'author') {
        console.log('Loading author data:', item);
        console.log('Author item keys:', Object.keys(item));

        // Try multiple possible field mappings
        document.getElementById('authorName').value = item.name || item.title || item.fullName || '';
        document.getElementById('authorRole').value = item.role || item.position || item.jobTitle || '';
        document.getElementById('authorBio').value = item.bio || item.description || item.about || '';

        // Avatar - try multiple possible fields
        document.getElementById('authorAvatar').value = item.avatar || item.avatarUrl || item.photo || item.image || '';

        // Social media - try multiple structures
        const social = item.social || item.socialMedia || item.links || {};
        document.getElementById('authorTwitter').value = social.twitter || social.Twitter || '';
        document.getElementById('authorInsta').value = social.instagram || social.Instagram || '';
        document.getElementById('authorTiktok').value = social.tiktok || social.TikTok || '';

        // Expertise - try multiple structures
        if (item.expertise && Array.isArray(item.expertise)) {
          document.getElementById('authorExpertise').value = item.expertise.join('\n');
        } else if (item.expertise && typeof item.expertise === 'string') {
          document.getElementById('authorExpertise').value = item.expertise;
        } else if (item.skills && Array.isArray(item.skills)) {
          document.getElementById('authorExpertise').value = item.skills.join('\n');
        }

        updateSlug('author');
      }

      // Populate the content/body field for all content types
      const bodyContent = item.body || '';
      console.log('Loading body content for edit:', bodyContent ? 'Found ' + bodyContent.length + ' chars' : 'Empty body', 'item.body exists:', !!item.body, 'item.body type:', typeof item.body, 'item keys:', Object.keys(item));
      if (type !== 'media') {
        // First, set the textarea content
        document.getElementById('mainContent').value = bodyContent;

        // Then initialize SimpleMDE and set its value
        setTimeout(() => {
          initializeEditor();
          if (simpleMDE) {
            simpleMDE.value(bodyContent);
          }
        }, 150);
      }
    }

    async function saveContent(fm, filename, type) {
      // Try local development server first (port 3001)
      try {
        const response = await fetch('http://localhost:3001/api/save-content', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            filename: filename,
            content: fm,
            type: type.charAt(0).toUpperCase() + type.slice(1)
          })
        });

        if (response.ok) {
          const result = await response.json();
          alert(`‚úÖ Content saved successfully!\n\nFile: src/${filename}.md\n\nChanges will be reflected after rebuild.`);
          setTimeout(() => window.location.reload(), 1000);
          return true;
        }
      } catch (e) {
        console.warn('Local development server not available, trying Netlify function...');
      }

      // Production/GitHub workflow - commit to repository
      try {
        const response = await fetch('/.netlify/functions/save-content', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            filename: filename,
            content: fm,
            type: type.charAt(0).toUpperCase() + type.slice(1),
            action: 'commit'
          })
        });

        const result = await response.json();

        if (response.ok && result.success) {
          alert(`‚úÖ Content committed to repository!\n\nFile: src/${filename}.md\n\nThe site will be rebuilt automatically.`);
          closeModal();
          // Refresh data after short delay to allow build to start
          setTimeout(() => window.location.reload(), 2000);
          return true;
        } else {
          // Show the actual error from the API
          const errorMsg = result.message || result.error || 'Unknown error';
          alert(`‚ùå Failed to save content:\n\n${errorMsg}\n\nPlease check your GitHub token permissions.`);
          return false;
        }
      } catch (e) {
        console.error('Save content error:', e);
        alert(`‚ùå Failed to save content:\n\n${e.message}\n\nFalling back to clipboard method.`);
      }

      // Fallback to clipboard copy - always available
      console.log('Using clipboard fallback');
      return false;
    }

    function generateFrontmatter(e) {
      e.preventDefault();
      const type = document.getElementById('contentType').value;
      console.log('generateFrontmatter called, type:', type, 'editingItemId:', editingItemId);

      // Media has its own upload button
      if (type === 'media') {
        alert('Please use the "Upload to Repository" button to upload media files.');
        return;
      }

      let fm = '---\n';
      let filename = 'content';

      if (type === 'blog') {
        const t = document.getElementById('blogTitle').value;
        if (!t) {
          alert('Please enter a post title');
          return;
        }
        fm += `title: "${t.replace(/"/g, '\\"')}"\n`;
        fm += `description: "${document.getElementById('blogDesc').value.replace(/"/g, '\\"')}"\n`;
        fm += `date: ${new Date(document.getElementById('blogDate').value).toISOString()}\n`;
        fm += `author: "${document.getElementById('blogAuthor').value}"\n`;
        const tags = document.getElementById('blogTags').value;
        if (tags) { fm += 'tags:\n'; tags.split(',').forEach(t => fm += `  - ${t.trim()}\n`); }
        const img = document.getElementById('blogImage').value;
        if (img) fm += `image: ${img}\n`;
        const cat = document.getElementById('blogCategory').value;
        if (cat) fm += `category: ${cat}\n`;
        if (document.getElementById('blogFeatured').checked) fm += `featured: true\n`;
        if (document.getElementById('blogDraft').checked) fm += `draft: true\n`;
        const alt = document.getElementById('blogImageAlt').value;
        if (alt) fm += `imageAlt: "${alt}"\n`;
        const kw = document.getElementById('blogKeywords').value;
        if (kw) fm += `keywords: "${kw}"\n`;
        fm += `schema_type: ${document.getElementById('blogSchema').value}\n`;
        fm += `og_type: ${document.getElementById('blogOg').value}\n`;

        // Use original filename if editing, otherwise generate new
        if (editingItemId) {
          filename = 'blog/' + editingItemId;
        } else {
          filename = 'blog/' + document.getElementById('blogDate').value.split('T')[0] + '-' + t.toLowerCase().replace(/[^a-z0-9]+/g, '-');
        }
      }
      else if (type === 'hub') {
        const t = document.getElementById('hubTitle').value;
        if (!t) {
          alert('Please enter a hub title');
          return;
        }
        fm += `layout: hub.njk\n`;
        fm += `title: "${t}"\n`;
        fm += `description: "${document.getElementById('hubDesc').value}"\n`;
        fm += `hubCollection: ${document.getElementById('hubCollection').value}\n`;
        fm += `permalink: ${document.getElementById('hubPermalink').value}\n`;

        if (editingItemId) {
          filename = 'hubs/' + editingItemId;
        } else {
          filename = 'hubs/' + t.toLowerCase().replace(/[^a-z0-9]+/g, '-');
        }
      }
      else if (type === 'author') {
        console.log('Processing author save...');
        const n = document.getElementById('authorName').value;
        console.log('Author name:', n);
        if (!n) {
          alert('Please enter author name');
          return;
        }
        fm += `name: "${n}"\n`;
        fm += `slug: ${n.toLowerCase().replace(/ /g, '-')}\n`;
        fm += `role: "${document.getElementById('authorRole').value}"\n`;
        fm += `bio: "${document.getElementById('authorBio').value}"\n`;
        const av = document.getElementById('authorAvatar').value;
        if (av) fm += `avatar: ${av}\n`;
        fm += `social:\n`;
        if (document.getElementById('authorTwitter').value) fm += `  twitter: ${document.getElementById('authorTwitter').value}\n`;
        if (document.getElementById('authorInsta').value) fm += `  instagram: ${document.getElementById('authorInsta').value}\n`;
        if (document.getElementById('authorTiktok').value) fm += `  tiktok: ${document.getElementById('authorTiktok').value}\n`;
        const exp = document.getElementById('authorExpertise').value;
        if (exp) { fm += `expertise:\n`; exp.split('\n').forEach(x => { if (x.trim()) fm += `  - ${x.trim()}\n`; }); }

        if (editingItemId) {
          filename = 'authors/' + editingItemId;
        } else {
          filename = 'authors/' + n.toLowerCase().replace(/ /g, '-');
        }
        console.log('Author filename:', filename);
      }
      else if (type === 'notification') {
        const t = document.getElementById('notifTitle').value;
        if (!t) {
          alert('Please enter notification title');
          return;
        }
        fm += `title: "${t}"\n`;
        fm += `date: ${document.getElementById('notifDate').value}\n`;
        if (document.getElementById('notifLink').value) fm += `link: ${document.getElementById('notifLink').value}\n`;
        fm += `tags:\n  - notification\n`;

        if (editingItemId) {
          filename = 'notifications/' + editingItemId;
        } else {
          filename = 'notifications/' + t.toLowerCase().replace(/[^a-z0-9]+/g, '-');
        }
      }
      else if (type === 'page') {
        const t = document.getElementById('pageTitle').value;
        if (!t) {
          alert('Please enter page title');
          return;
        }
        fm += `title: "${t}"\n`;
        fm += `layout: ${document.getElementById('pageLayout').value}\n`;
        fm += `permalink: ${document.getElementById('pagePermalink').value}\n`;

        if (editingItemId) {
          filename = 'pages/' + editingItemId;
        } else {
          filename = 'pages/' + t.toLowerCase().replace(/[^a-z0-9]+/g, '-');
        }
      }

      const content = simpleMDE ? simpleMDE.value() : document.getElementById('mainContent').value;
      fm += '---\n\n' + content;

      // Try to save directly first
      saveContent(fm, filename, type).then(success => {
        if (!success) {
          // Fallback to clipboard
          navigator.clipboard.writeText(fm).then(() => {
            alert(`‚úÖ Content copied to clipboard!\n\nCreate file: src/${filename}.md\n\nPaste the content and save the file.`);
            closeModal();
          }).catch(err => {
            alert('Error copying to clipboard. Please copy manually.');
            console.error(err);
          });
        }
      });
    }

    // Copy code only functionality
    function generateFrontmatterProto() {
      const type = document.getElementById('contentType').value;
      let fm = '---\n';
      let filename = 'content';

      if (type === 'blog') {
        const t = document.getElementById('blogTitle').value;
        if (!t) {
          alert('Please enter a post title');
          return;
        }
        fm += `title: "${t.replace(/"/g, '\\"')}"\n`;
        fm += `description: "${document.getElementById('blogDesc').value.replace(/"/g, '\\"')}"\n`;
        fm += `date: ${new Date(document.getElementById('blogDate').value).toISOString()}\n`;
        fm += `author: "${document.getElementById('blogAuthor').value}"\n`;
        const tags = document.getElementById('blogTags').value;
        if (tags) { fm += 'tags:\n'; tags.split(',').forEach(t => fm += `  - ${t.trim()}\n`); }
        const img = document.getElementById('blogImage').value;
        if (img) fm += `image: ${img}\n`;
        const cat = document.getElementById('blogCategory').value;
        if (cat) fm += `category: ${cat}\n`;
        if (document.getElementById('blogFeatured').checked) fm += `featured: true\n`;
        if (document.getElementById('blogDraft').checked) fm += `draft: true\n`;
        const alt = document.getElementById('blogImageAlt').value;
        if (alt) fm += `imageAlt: "${alt}"\n`;
        const kw = document.getElementById('blogKeywords').value;
        if (kw) fm += `keywords: "${kw}"\n`;
        fm += `schema_type: ${document.getElementById('blogSchema').value}\n`;
        fm += `og_type: ${document.getElementById('blogOg').value}\n`;
        filename = 'blog/' + document.getElementById('blogDate').value.split('T')[0] + '-' + t.toLowerCase().replace(/[^a-z0-9]+/g, '-');
      }
      // Add other types as needed...

      const content = simpleMDE ? simpleMDE.value() : document.getElementById('mainContent').value;
      fm += '---\n\n' + content;

      navigator.clipboard.writeText(fm).then(() => {
        alert(`‚úÖ Frontmatter copied to clipboard!\n\nYou can now manually create the file:\nsrc/${filename}.md`);
      }).catch(err => {
        alert('Error copying to clipboard. Please copy manually.');
        console.error(err);
      });
    }

    document.getElementById('contentForm').addEventListener('submit', generateFrontmatter);
    function viewContent(url) { window.open(url, '_blank'); }
    function closeModal() {
      document.getElementById('editModal').style.display = 'none';
      if (simpleMDE) {
        simpleMDE.toTextArea();
        simpleMDE = null;
      }
    }

    // Delete content via GitHub API
    async function deleteContent(type, id, title) {
      const confirmMsg = `‚ö†Ô∏è Are you sure you want to delete "${title}"?\n\nThis action cannot be undone!`;

      if (!confirm(confirmMsg)) {
        return;
      }

      // Map type to directory
      const typeToDir = {
        'blog': 'blog',
        'hub': 'hubs',
        'author': 'authors',
        'notification': 'notifications',
        'page': 'pages'
      };
      const dir = typeToDir[type] || type;
      const filename = `${dir}/${id}`;

      try {
        const response = await fetch('/.netlify/functions/save-content', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            filename: filename,
            type: type.charAt(0).toUpperCase() + type.slice(1),
            action: 'delete'
          })
        });

        const result = await response.json();

        if (response.ok && result.success) {
          alert(`‚úÖ Content deleted successfully!\n\nFile: src/${filename}.md\n\nThe site will be rebuilt automatically.`);
          // Refresh the page to update the list
          setTimeout(() => window.location.reload(), 2000);
        } else {
          const errorMsg = result.message || result.error || 'Unknown error';
          alert(`‚ùå Failed to delete content:\n\n${errorMsg}`);
        }
      } catch (e) {
        console.error('Delete error:', e);
        alert(`‚ùå Failed to delete content:\n\n${e.message}\n\nYou can manually delete: src/${filename}.md`);
      }
    }

    window.onclick = function (e) { if (e.target == document.getElementById('editModal')) closeModal(); }

    // Initialize on load
    window.onload = async function () {
      console.log('Loading CMS data...');
      await loadContentData();
      loadBlogPosts();
      loadHubContent();
      loadAuthors();
      console.log('CMS initialized successfully');
    }

    // Blog Image Specific Uploaders
    function handleBlogImageUpload(e) {
      const file = e.target.files[0];
      if (file) uploadBlogImage(file);
    }

    function handleBlogImageDrop(e) {
      const file = e.dataTransfer.files[0];
      if (file) uploadBlogImage(file);
    }

    async function uploadBlogImage(file) {
      if (!file.type.startsWith('image/')) {
        alert('‚ùå Please select an image file');
        return;
      }

      // Show loading
      const dropZone = document.getElementById('blogImageDropZone');
      const originalHTML = dropZone.innerHTML;
      dropZone.innerHTML = '<p style="margin:0; color:#33bdef; font-size:0.9em;">‚è≥ Uploading...</p>';
      dropZone.style.pointerEvents = 'none';

      try {
        const base64Content = await new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = () => resolve(reader.result.split(',')[1]);
          reader.onerror = reject;
          reader.readAsDataURL(file);
        });

        const sanitizedName = file.name.toLowerCase().replace(/[^a-z0-9.-]/g, '-');
        // Use assets/blog/ as implied by the original placeholder
        const filePath = `assets/blog/${sanitizedName}`;

        // Try local dev server first
        let response;
        try {
          response = await fetch('http://localhost:3001/api/save-content', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              filename: filePath,
              content: base64Content,
              type: 'Media',
              action: 'upload-binary',
              isBase64: true
            })
          });
          if (!response.ok) throw new Error('Local server failed');
        } catch (e) {
          // Fallback to Netlify Function
          response = await fetch('/.netlify/functions/save-content', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              filename: filePath,
              content: base64Content,
              type: 'Media',
              action: 'upload-binary',
              isBase64: true
            })
          });
        }

        const result = await response.json();

        if (response.ok && result.success) {
          const finalPath = `/${filePath}`;
          updateBlogImagePreview(finalPath);
        } else {
          throw new Error(result.message || 'Upload failed');
        }
      } catch (err) {
        console.error(err);
        alert('Upload failed: ' + err.message);
      } finally {
        dropZone.innerHTML = originalHTML;
        dropZone.style.pointerEvents = 'auto';
      }
    }

    function updateBlogImagePreview(path) {
      const preview = document.getElementById('blogImagePreview');
      const dropZone = document.getElementById('blogImageDropZone');
      const input = document.getElementById('blogImage');

      if (input) input.value = path; // Sync hidden input

      if (path && preview && dropZone) {
        document.getElementById('blogImagePreviewImg').src = path;
        document.getElementById('blogImagePathDisplay').textContent = path;

        dropZone.style.display = 'none';
        preview.style.display = 'flex';
      } else if (preview && dropZone) {
        dropZone.style.display = 'block';
        preview.style.display = 'none';
      }
    }

    function removeBlogImage() {
      updateBlogImagePreview('');
      document.getElementById('blogImageInput').value = ''; // Reset file input
    }

    // ========== MEDIA INSERT PANEL (in-editor) ==========
    const ASPECT_MAP = {
      '16:9': '56.25%',
      '4:3': '75%',
      '1:1': '100%',
      '9:16': '177.78%',
      '3:2': '66.67%',
      '21:9': '42.86%',
      'auto': 'auto'
    };

    let currentMediaPanelType = null; // 'image', 'video', or 'upload'

    function toggleMediaPanel(type) {
      const existing = document.getElementById('mediaInsertPanel');
      // If same type clicked again, close
      if (existing && currentMediaPanelType === type) {
        existing.remove();
        currentMediaPanelType = null;
        return;
      }
      // Remove existing panel if different type
      if (existing) existing.remove();
      currentMediaPanelType = type;
      createMediaPanel(type);
    }

    function closeMediaPanel() {
      const panel = document.getElementById('mediaInsertPanel');
      if (panel) panel.remove();
      currentMediaPanelType = null;
    }

    function createMediaPanel(type) {
      const toolbar = document.querySelector('.editor-toolbar');
      if (!toolbar) return;

      const panel = document.createElement('div');
      panel.id = 'mediaInsertPanel';
      panel.className = 'media-insert-panel';

      const titles = { image: 'üñºÔ∏è Insert Image', video: 'üé¨ Insert Video', upload: 'üì§ Upload from PC' };

      let tabsHTML = '';
      if (type === 'image' || type === 'video') {
        tabsHTML = `
          <div class="mip-tabs">
            <button type="button" class="mip-tab active" onclick="switchMediaTab(this, 'url')">üîó Enter URL</button>
            <button type="button" class="mip-tab" onclick="switchMediaTab(this, 'upload')">üìÅ Upload File</button>
          </div>`;
      }

      const acceptAttr = type === 'video' ? 'video/*' : (type === 'upload' ? 'image/*,video/*' : 'image/*');
      const typeForUpload = type === 'upload' ? 'auto' : type;

      const aspectOptions = `
        <option value="16:9">16:9 Widescreen</option>
        <option value="4:3">4:3 Standard</option>
        <option value="1:1">1:1 Square</option>
        <option value="9:16">9:16 Portrait</option>
        <option value="3:2">3:2 Classic</option>
        <option value="21:9">21:9 Ultrawide</option>
        <option value="auto">Auto</option>`;

      panel.innerHTML = `
        <div class="mip-header">
          <h4>${titles[type] || titles.image}</h4>
          <button type="button" class="mip-close" onclick="closeMediaPanel()" title="Close">‚úï</button>
        </div>
        ${tabsHTML}
        <div class="mip-body">
          <!-- URL Tab -->
          <div id="mipUrlTab" style="display:${type === 'upload' ? 'none' : 'flex'}; flex-direction:column; gap:10px;">
            <div class="mip-row">
              <input type="text" id="mipUrl" placeholder="${type === 'video' ? 'YouTube URL, video URL, or path...' : 'Image URL or path (e.g. /assets/blog/photo.jpg)'}" style="flex:1;">
            </div>
          </div>
          <!-- Upload Tab -->
          <div id="mipUploadTab" style="display:${type === 'upload' ? 'block' : 'none'};">
            <div class="mip-upload-zone" id="mipDropZone"
              onclick="document.getElementById('mipFileInput').click()"
              ondragover="event.preventDefault(); this.classList.add('dragging');"
              ondragleave="this.classList.remove('dragging');"
              ondrop="event.preventDefault(); this.classList.remove('dragging'); handleMediaPanelDrop(event);">
              <div class="upload-icon">${type === 'video' ? 'üé¨' : (type === 'upload' ? 'üìÇ' : 'üñºÔ∏è')}</div>
              <div class="upload-text">Click to browse or drag & drop</div>
              <div class="upload-hint">${type === 'video' ? 'MP4, WebM, MOV' : (type === 'upload' ? 'Images or videos' : 'PNG, JPG, WebP, GIF, SVG')}</div>
            </div>
            <input type="file" id="mipFileInput" accept="${acceptAttr}" style="display:none;" onchange="handleMediaPanelFileSelect(event)">
            <div class="mip-upload-progress" id="mipUploadProgress"></div>
          </div>
          <!-- Common controls -->
          <div class="mip-row">
            <select id="mipAspect" style="min-width:140px;">${aspectOptions}</select>
            <input type="text" id="mipAlt" placeholder="Alt text / caption (optional)" style="flex:1;">
          </div>
          <input type="hidden" id="mipType" value="${typeForUpload}">
        </div>
        <div class="mip-actions">
          <button type="button" class="btn" onclick="closeMediaPanel()">Cancel</button>
          <button type="button" class="btn primary" id="mipInsertBtn" onclick="insertFromMediaPanel()">üì• Insert into Editor</button>
        </div>`;

      toolbar.after(panel);
    }

    function switchMediaTab(btn, tab) {
      // Update tab active state
      btn.closest('.mip-tabs').querySelectorAll('.mip-tab').forEach(t => t.classList.remove('active'));
      btn.classList.add('active');
      // Show/hide
      document.getElementById('mipUrlTab').style.display = tab === 'url' ? 'flex' : 'none';
      document.getElementById('mipUploadTab').style.display = tab === 'upload' ? 'block' : 'none';
    }

    function handleMediaPanelFileSelect(e) {
      const file = e.target.files[0];
      if (file) uploadMediaPanelFile(file);
    }

    function handleMediaPanelDrop(e) {
      const file = e.dataTransfer.files[0];
      if (file) uploadMediaPanelFile(file);
    }

    async function uploadMediaPanelFile(file) {
      const progressEl = document.getElementById('mipUploadProgress');
      const insertBtn = document.getElementById('mipInsertBtn');
      const dropZone = document.getElementById('mipDropZone');

      // Auto-detect type from file
      const mipTypeEl = document.getElementById('mipType');
      if (mipTypeEl && mipTypeEl.value === 'auto') {
        mipTypeEl.value = file.type.startsWith('video/') ? 'video' : 'image';
      }

      // Validate file type
      if (!file.type.startsWith('image/') && !file.type.startsWith('video/')) {
        alert('‚ùå Please select an image or video file.');
        return;
      }

      progressEl.style.display = 'block';
      progressEl.style.background = '#e0f2fe';
      progressEl.innerHTML = '‚è≥ Uploading <strong>' + file.name + '</strong>...';
      if (dropZone) dropZone.style.pointerEvents = 'none';
      if (insertBtn) insertBtn.disabled = true;

      try {
        const base64Content = await new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = () => resolve(reader.result.split(',')[1]);
          reader.onerror = reject;
          reader.readAsDataURL(file);
        });

        const sanitizedName = file.name.toLowerCase().replace(/[^a-z0-9.-]/g, '-');
        const subDir = file.type.startsWith('video/') ? 'assets/video' : 'assets/blog';
        const filePath = `${subDir}/${sanitizedName}`;

        let response;
        try {
          response = await fetch('http://localhost:3001/api/save-content', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ filename: filePath, content: base64Content, type: 'Media', action: 'upload-binary', isBase64: true })
          });
          if (!response.ok) throw new Error('Local server failed');
        } catch (e) {
          response = await fetch('/.netlify/functions/save-content', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ filename: filePath, content: base64Content, type: 'Media', action: 'upload-binary', isBase64: true })
          });
        }

        const result = await response.json();
        if (response.ok && result.success) {
          const finalPath = `/${filePath}`;
          progressEl.style.background = '#dcfce7';
          progressEl.innerHTML = `‚úÖ Uploaded: <strong>${finalPath}</strong>`;

          // Fill the URL field with the uploaded path
          const urlInput = document.getElementById('mipUrl');
          if (urlInput) urlInput.value = finalPath;

          // Switch to URL tab view so user can see the path
          const urlTab = document.getElementById('mipUrlTab');
          if (urlTab) urlTab.style.display = 'flex';
        } else {
          throw new Error(result.message || 'Upload failed');
        }
      } catch (err) {
        console.error(err);
        progressEl.style.background = '#fee2e2';
        progressEl.innerHTML = '‚ùå Upload failed: ' + err.message;
      } finally {
        if (dropZone) dropZone.style.pointerEvents = 'auto';
        if (insertBtn) insertBtn.disabled = false;
      }
    }

    function insertFromMediaPanel() {
      const url = document.getElementById('mipUrl')?.value.trim();
      const aspect = document.getElementById('mipAspect')?.value || 'auto';
      const alt = document.getElementById('mipAlt')?.value.trim() || '';
      const type = document.getElementById('mipType')?.value || 'image';

      if (!url) {
        alert('Please enter a URL/path or upload a file first.');
        return;
      }

      const markdown = generateMediaMarkdown(type, url, aspect, alt);

      // Insert into SimpleMDE at cursor
      if (simpleMDE) {
        const cm = simpleMDE.codemirror;
        const cursor = cm.getCursor();
        cm.replaceRange(markdown, cursor);
        cm.focus();
      } else {
        const ta = document.getElementById('mainContent');
        const start = ta.selectionStart;
        ta.value = ta.value.slice(0, start) + markdown + ta.value.slice(start);
      }

      closeMediaPanel();
    }

    function generateMediaMarkdown(type, url, aspect, alt) {
      if (type === 'image') {
        if (aspect === 'auto') {
          return `\n![${alt || 'image'}](${url})\n`;
        }
        return `\n<div style="position:relative;width:100%;padding-bottom:${ASPECT_MAP[aspect]};overflow:hidden;border-radius:8px;margin:20px 0;"><img src="${url}" alt="${alt || 'image'}" style="position:absolute;top:0;left:0;width:100%;height:100%;object-fit:cover;" /></div>\n`;
      } else if (type === 'video') {
        const ytMatch = url.match(/(?:youtube\.com\/watch\?v=|youtu\.be\/|youtube\.com\/embed\/)([a-zA-Z0-9_-]{11})/);
        if (ytMatch) {
          return `\n<div style="position:relative;width:100%;padding-bottom:${ASPECT_MAP[aspect] || '56.25%'};overflow:hidden;border-radius:8px;margin:20px 0;"><iframe src="https://www.youtube.com/embed/${ytMatch[1]}" style="position:absolute;top:0;left:0;width:100%;height:100%;border:none;" allowfullscreen></iframe></div>\n`;
        }
        return `\n<div style="position:relative;width:100%;padding-bottom:${ASPECT_MAP[aspect] || '56.25%'};overflow:hidden;border-radius:8px;margin:20px 0;"><video src="${url}" style="position:absolute;top:0;left:0;width:100%;height:100%;object-fit:cover;" controls${alt ? ` title="${alt}"` : ''}></video></div>\n`;
      }
      return '';
    }

    // ========== AI SEO GENERATION ==========
    async function generateSEO() {
      const btn = document.getElementById('btnGenerateSEO');
      const originalText = btn.innerHTML;

      // Ensure editor content is synced/retrieved
      let content = '';
      if (simpleMDE) {
        content = simpleMDE.value();
      } else {
        content = document.getElementById('mainContent').value;
      }

      const currentTitle = document.getElementById('blogTitle').value;

      // Collect available categories
      const categorySelect = document.getElementById('blogCategory');
      const availableCategories = Array.from(categorySelect.options)
        .map(opt => opt.value)
        .filter(val => val !== ''); // Exclude empty/default option

      console.log('Generating SEO for content length:', content.length);

      if (!content || content.length < 50) {
        alert('‚ö†Ô∏è Please write at least a few sentences of content so the AI can analyze it.');
        return;
      }

      btn.disabled = true;
      btn.innerHTML = '‚ú® Analyzing & Generating...';
      btn.style.opacity = '0.8';
      btn.style.cursor = 'wait';

      try {
        const payload = { content, currentTitle, availableCategories };
        console.log('Sending payload:', { ...payload, content: content.substring(0, 50) + '...' });
        let response;

        // Try local helper first (if running locally), then Netlify function
        try {
          response = await fetch('http://localhost:3001/api/generate-seo', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          });
          if (!response.ok) throw new Error('Local dev unavailable');
        } catch (e) {
          response = await fetch('/.netlify/functions/generate-seo', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          });
        }

        if (!response.ok) {
          const errData = await response.text();
          console.error(`API Error: ${errData}`);
          throw new Error('API Request Failed: ' + (JSON.parse(errData).error?.message || errData));
        }

        const data = await response.json();
        console.log('Received SEO Data:', data);

        // Populate fields with animation effect
        const fields = [
          { id: 'blogTitle', val: data.title },
          { id: 'blogDesc', val: data.description },
          { id: 'blogKeywords', val: data.keywords },
          { id: 'blogImageAlt', val: data.imageAlt },
          { id: 'blogCategory', val: data.category } // Set category
        ];

        fields.forEach(f => {
          const el = document.getElementById(f.id);
          if (el && f.val) {
            el.value = f.val;
            el.style.transition = 'background-color 0.5s';
            el.style.backgroundColor = '#d1fae5'; // highlight green
            setTimeout(() => el.style.backgroundColor = '', 1500);
          }
        });

        // Update slug preview based on new title
        if (data.title) updateSlug('blog');

        alert('‚ú® High-Impact SEO Metadata Generated!\n\nReview the highlighted fields.');

      } catch (error) {
        console.error('SEO Generation Error:', error);
        alert('‚ùå Failed to generate SEO: ' + error.message);
      } finally {
        btn.disabled = false;
        btn.innerHTML = originalText;
        btn.style.opacity = '1';
        btn.style.cursor = 'pointer';
      }
    }

  </script>
</body>

</html>