<!DOCTYPE html> 
<html lang="{{ lang or 'en' }}">
<head>
    <meta charset="UTF-8">
    <meta name="fo-verify" content="80725f6c-bd05-4617-9441-22d8dec11e7f" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="manifest" href="/manifest.json">

    <!-- Hreflang Tags -->
    <link rel="alternate" hreflang="en" href="{{ metadata.url }}{{ page.url | replace('/es/', '/') }}" />
    <link rel="alternate" hreflang="es" href="{{ metadata.url }}/es{{ page.url | replace('/es/', '/') }}" />
    <link rel="alternate" hreflang="x-default" href="{{ metadata.url }}{{ page.url | replace('/es/', '/') }}" />

    {# === OPEN GRAPH META TAGS (Facebook, LinkedIn, WhatsApp, etc.) === #}
    {% if image %}
      {# Use the actual Article Hero Image as requested #}
      <meta property="og:image" content="{{ image | absoluteUrl(metadata.url) }}">
      <meta property="og:image:secure_url" content="{{ image | absoluteUrl(metadata.url) }}">
      <meta property="og:image:alt" content="{{ imageAlt or title }}">
    {% elif metadata.image %}
      {# Fallback to site default if post has no image #}
      <meta property="og:image" content="{{ metadata.image | absoluteUrl(metadata.url) }}">
      <meta property="og:image:secure_url" content="{{ metadata.image | absoluteUrl(metadata.url) }}">
      <meta property="og:image:alt" content="{{ metadata.title }}">
    {% endif %}

    <meta property="og:title" content="{{ title or metadata.title }}">
    <meta property="og:description" content="{{ (description or metadata.description) | truncate(160) }}">
    <meta property="og:url" content="{{ page.url | absoluteUrl(metadata.url) }}">
    <meta property="og:type" content="{{ og_type or 'website' }}">
    <meta property="og:site_name" content="{{ metadata.title }}">

    {# === TWITTER CARD META TAGS (X/Twitter) === #}
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:site" content="@{{ metadata.author.twitter }}">
    <meta name="twitter:domain" content="blog.evolvedlotus.com">
    {% if author %}<meta name="twitter:creator" content="@{{ author | replace('@', '') }}">{% endif %}
    <meta name="twitter:title" content="{{ title or metadata.title }}">
    <meta name="twitter:description" content="{{ (description or metadata.description) | truncate(160) }}">

    {% if image %}
      <meta name="twitter:image" content="{{ image | absoluteUrl(metadata.url) }}">
      <meta name="twitter:image:alt" content="{{ imageAlt or title }}">
    {% elif metadata.image %}
      <meta name="twitter:image" content="{{ metadata.image | absoluteUrl(metadata.url) }}">
      <meta name="twitter:image:alt" content="{{ metadata.title }}">
    {% endif %}

    <!-- Global SEO Meta Tags -->
    <meta name="title" content="{{ title or metadata.title }}">
    <meta name="description" content="{{ description or metadata.description }}">
    <meta name="keywords" content="{{ keywords or 'content creation, social media, SEO, blogging, digital marketing' }}">
    <meta name="robots" content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1">
    <meta name="author" content="{{ author or 'EvolvedLotus' }}">
    <meta name="publisher" content="EvolvedLotus">
    <meta name="language" content="English">
    <meta name="geo.region" content="US">
    <meta name="geo.placename" content="United States">
    <meta name="distribution" content="global">
    <meta name="google-adsense-account" content="ca-pub-7311583434347173">

    <!-- Article-specific Meta Tags (only shown when og:type is "article") -->
    {% if og_type == 'article' %}
      {% if date %}
      <meta property="article:published_time" content="{{ date | isoDate }}">
      <meta property="article:modified_time" content="{{ lastModified | isoDate if lastModified else date | isoDate }}">
      {% endif %}
      {% if author %}
      <meta property="article:author" content="{{ author }}">
      {% endif %}
      {% if article_section %}
      <meta property="article:section" content="{{ article_section }}">
      {% endif %}
      <meta property="article:publisher" content="{{ metadata.url }}">
      {% if tags %}
        {% for tag in tags %}
          {% if tag != 'post' and tag != 'featured' %}
          <meta property="article:tag" content="{{ tag }}">
          {% endif %}
        {% endfor %}
      {% endif %}
    {% endif %}

    <!-- Platform-specific enhancements -->
    <!-- Discord Embed Tags -->
    <meta property="discord:embed" content="true">
    <meta property="discord:embed:title" content="{{ title or metadata.title }}">
    <meta property="discord:embed:description" content="{{ description or metadata.description }}">
    {% set socialImagePath = image if image else metadata.image %}
    <meta property="discord:embed:image" content="{{ metadata.url }}{{ socialImagePath }}">
    <meta property="discord:embed:url" content="{{ metadata.url }}{{ page.url }}">
    <meta property="discord:embed:color" content="#007bff">

    <!-- LinkedIn Specific Tags -->
    <meta property="linkedin:owner" content="urn:li:organization:123456789">
    <meta property="linkedin:page" content="evolvedlotus">

    <!-- Pinterest Specific Tags -->
    <meta name="pinterest-rich-pin" content="true">

    <!-- WhatsApp Specific Tags -->
    <meta property="whatsapp:image" content="{{ metadata.url }}{{ socialImagePath }}">
    <meta property="whatsapp:title" content="{{ title or metadata.title }}">
    <meta property="whatsapp:description" content="{{ description or metadata.description }}">

    <!-- Telegram Specific Tags -->
    <meta property="telegram:image" content="{{ metadata.url }}{{ socialImagePath }}">
    <meta property="telegram:title" content="{{ title or metadata.title }}">
    <meta property="telegram:description" content="{{ description or metadata.description }}">

    <!-- Reddit Specific Tags -->
    <meta property="reddit:card" content="summary_large_image">

    <!-- Theme and Appearance -->
    <meta property="theme-color" content="#007bff">
    <meta name="color-scheme" content="light">
    <meta name="msapplication-TileColor" content="#007bff">

    <!-- Structured Data for Rich Snippets -->
    {% include "schema.njk" %}

    <title>{{ title or metadata.title }}</title>
    <link rel="canonical" href="{{ metadata.url }}{{ page.url }}" />
    <!-- SEO Enhancement: Add canonical tags to prevent duplicate content issues -->
    {% set cssVersion = "v=" + (page.date | date('X') if page.date else "20251203") %}
    <link rel="stylesheet" href="/dark-mode.css?{{ cssVersion }}">
    <link rel="stylesheet" href="/style.css?{{ cssVersion }}">
    <link rel="stylesheet" href="/print.css?{{ cssVersion }}" media="print">
    <link rel="stylesheet" href="/enhancements.css?{{ cssVersion }}">
    <link rel="stylesheet" href="/layout-fixes.css?{{ cssVersion }}">
    <link rel="stylesheet" href="/ux-enhancements.css?{{ cssVersion }}">
    <link rel="stylesheet" href="/conversion-components.css?{{ cssVersion }}">
    <link rel="stylesheet" href="/homepage-fixes.css?{{ cssVersion }}">
    <link rel="stylesheet" href="/homepage-carousel.css?{{ cssVersion }}">
    <link rel="stylesheet" href="/article-layout.css?{{ cssVersion }}">
    <link rel="stylesheet" href="/landing-page.css?{{ cssVersion }}">

    {# Added preconnect hints for critical third-party origins #}
    <link rel="preconnect" href="https://pagead2.googlesyndication.com">
    <link rel="preconnect" href="https://identity.netlify.com">
    <link rel="preconnect" href="https://ep2.adtrafficquality.google">
    <link rel="preconnect" href="https://www.googletagmanager.com">

    {% if settings.analytics.googleAnalytics and settings.analytics.googleAnalytics != "GA4_MEASUREMENT_ID" %}
    {% include "analytics.njk" %}
    {% endif %}

    {% include "schema.njk" %}
</head>
<body>
    <a href="#main-content" class="skip-link">Skip to content</a>
    {% include 'header.njk' %}
    <div class="main-container">
        <main class="content-area" id="main-content">
            {{ content | safe }}
        </main>

    </div>
    {% include 'blogsign.njk' %}
    {% include 'footer.njk' %}

    {# 
      Moved all JavaScripts to just before the closing </body> tag for better performance.
      Added 'defer' to Netlify Identity, slideshow.js, and copy.js.
      Kept 'async' for Adsense script as it's already there and standard for ads.
    #}
    <script src="https://identity.netlify.com/v1/netlify-identity-widget.js" defer></script>
    <script>
        if (window.netlifyIdentity) {
            window.netlifyIdentity.on("init", user => {
                if (!user) {
                    window.netlifyIdentity.on("login", () => {
                        document.location.href = "/admin/";
                    });
                }
            });
        }
    </script>

    <script src="/assets/js/slideshow.js?{{ cssVersion }}" defer></script>
    <script src="/assets/js/copy.js?{{ cssVersion }}" defer></script>
    <script src="/assets/js/short-url.js?{{ cssVersion }}" defer></script>
    <script src="/assets/js/reading-progress.js?{{ cssVersion }}" defer></script>
    <script src="/assets/js/analytics-tracker.js?{{ cssVersion }}" defer></script>
    <script src="/assets/js/ab-testing.js?{{ cssVersion }}" defer></script>

    <script>
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
          navigator.serviceWorker.register('/sw.js').then(registration => {
            console.log('ServiceWorker registration successful with scope: ', registration.scope);
          }, err => {
            console.log('ServiceWorker registration failed: ', err);
          });
        });
      }
    </script>

    <!-- Settings Widget (Dark Mode + Language Switcher) -->
    <!-- Settings Widget moved to Header -->
    {% include "google-translate.njk" %}
</body>
</html>
