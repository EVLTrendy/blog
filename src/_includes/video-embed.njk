{% if videoUrl %}
{# Determine video platform #}
{% set isYouTube = videoUrl.includes('youtube.com') or videoUrl.includes('youtu.be') %}
{% set isVimeo = videoUrl.includes('vimeo.com') %}
{% set isTikTok = videoUrl.includes('tiktok.com') %}

{# Extract video ID based on platform #}
{% if isYouTube %}
  {% set videoId = videoUrl | replace('https://www.youtube.com/watch?v=', '') | replace('https://youtu.be/', '') | replace('&', '?') | split('?') | first %}
  {% set embedUrl = 'https://www.youtube-nocookie.com/embed/' + videoId %}
  {% set thumbnailUrl = 'https://img.youtube.com/vi/' + videoId + '/maxresdefault.jpg' %}
{% elif isVimeo %}
  {% set videoId = videoUrl | replace('https://vimeo.com/', '') | split('/') | first %}
  {% set embedUrl = 'https://player.vimeo.com/video/' + videoId %}
  {% set thumbnailUrl = '' %}
{% elif isTikTok %}
  {% set videoId = videoUrl | replace('https://www.tiktok.com/', '') %}
  {% set embedUrl = 'https://www.tiktok.com/embed/' + videoId %}
  {% set thumbnailUrl = '' %}
{% endif %}

{% set platform = 'unknown' %}
{% if isYouTube %}
  {% set platform = 'youtube' %}
{% elif isVimeo %}
  {% set platform = 'vimeo' %}
{% elif isTikTok %}
  {% set platform = 'tiktok' %}
{% endif %}

<div class="video-embed-container" data-video-platform="{{ platform }}">
  <div class="video-wrapper">
    {% if isYouTube %}
      {# YouTube with lazy loading #}
      <div class="video-placeholder" data-embed-url="{{ embedUrl }}" style="background-image: url('{{ thumbnailUrl }}');">
        <button class="video-play-button" aria-label="Play video">
          <svg width="68" height="48" viewBox="0 0 68 48" fill="none">
            <path d="M66.52,7.74c-0.78-2.93-2.49-5.41-5.42-6.19C55.79,.13,34,0,34,0S12.21,.13,6.9,1.55 C3.97,2.33,2.27,4.81,1.48,7.74C0.06,13.05,0,24,0,24s0.06,10.95,1.48,16.26c0.78,2.93,2.49,5.41,5.42,6.19 C12.21,47.87,34,48,34,48s21.79-0.13,27.1-1.55c2.93-0.78,4.64-3.26,5.42-6.19C67.94,34.95,68,24,68,24S67.94,13.05,66.52,7.74z" fill="#f00"/>
            <path d="M 45,24 27,14 27,34" fill="#fff"/>
          </svg>
        </button>
      </div>
    {% elif isVimeo %}
      {# Vimeo embed #}
      <iframe 
        src="{{ embedUrl }}?dnt=1&title=0&byline=0&portrait=0" 
        frameborder="0" 
        allow="autoplay; fullscreen; picture-in-picture" 
        allowfullscreen
        loading="lazy"
        title="{{ title | default('Video') }}">
      </iframe>
    {% elif isTikTok %}
      {# TikTok embed #}
      <iframe 
        src="{{ embedUrl }}" 
        frameborder="0" 
        allow="autoplay; fullscreen; picture-in-picture" 
        allowfullscreen
        loading="lazy"
        title="{{ title | default('TikTok Video') }}">
      </iframe>
    {% endif %}
  </div>
  
  {% if videoTranscript %}
  <details class="video-transcript">
    <summary>üìù Video Transcript</summary>
    <div class="transcript-content">
      {{ videoTranscript | safe }}
    </div>
  </details>
  {% endif %}
</div>

{# VideoObject Schema Markup #}
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "VideoObject",
  "name": "{{ title | default('Video') }}",
  "description": "{{ description | default('') }}",
  "thumbnailUrl": "{{ thumbnailUrl if isYouTube else image | default('') }}",
  "uploadDate": "{{ date | isoDate }}",
  "contentUrl": "{{ videoUrl }}",
  "embedUrl": "{{ embedUrl }}",
  "publisher": {
    "@type": "Organization",
    "name": "{{ metadata.title }}",
    "logo": {
      "@type": "ImageObject",
      "url": "{{ metadata.url }}/assets/images/logo.png"
    }
  }
}
</script>

<style>
.video-embed-container {
  margin: 2rem 0;
  border-radius: 12px;
  overflow: hidden;
  box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
}

.video-wrapper {
  position: relative;
  padding-bottom: 56.25%; /* 16:9 aspect ratio */
  height: 0;
  overflow: hidden;
  background: #000;
}

.video-wrapper iframe {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
}

/* YouTube lazy loading placeholder */
.video-placeholder {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-size: cover;
  background-position: center;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: opacity 0.3s ease;
}

.video-placeholder:hover {
  opacity: 0.9;
}

.video-play-button {
  background: transparent;
  border: none;
  cursor: pointer;
  padding: 0;
  transition: transform 0.2s ease;
}

.video-play-button:hover {
  transform: scale(1.1);
}

/* TikTok specific styling */
[data-video-platform="tiktok"] .video-wrapper {
  padding-bottom: 177.78%; /* 9:16 aspect ratio for vertical video */
  max-width: 325px;
  margin: 0 auto;
}

/* Video transcript */
.video-transcript {
  background: var(--bg-secondary, #f9fafb);
  padding: 1rem;
  margin-top: 1rem;
  border-radius: 8px;
}

.video-transcript summary {
  cursor: pointer;
  font-weight: 600;
  padding: 0.5rem;
  user-select: none;
  list-style: none;
}

.video-transcript summary::-webkit-details-marker {
  display: none;
}

.video-transcript summary:hover {
  background: var(--bg-hover, #f3f4f6);
  border-radius: 4px;
}

.transcript-content {
  padding: 1rem 0.5rem;
  line-height: 1.6;
  color: var(--text-secondary, #4b5563);
}

@media (max-width: 768px) {
  .video-embed-container {
    margin: 1.5rem -1rem;
    border-radius: 0;
  }
}
</style>

<script>
// Lazy load YouTube videos on click
document.addEventListener('DOMContentLoaded', function() {
  const videoPlaceholders = document.querySelectorAll('.video-placeholder');
  
  videoPlaceholders.forEach(placeholder => {
    placeholder.addEventListener('click', function() {
      const embedUrl = this.getAttribute('data-embed-url');
      const iframe = document.createElement('iframe');
      
      iframe.setAttribute('src', embedUrl + '?autoplay=1');
      iframe.setAttribute('frameborder', '0');
      iframe.setAttribute('allow', 'accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture');
      iframe.setAttribute('allowfullscreen', '');
      iframe.setAttribute('title', 'YouTube video player');
      
      this.parentNode.replaceChild(iframe, this);
    });
  });
});
</script>
{% endif %}
