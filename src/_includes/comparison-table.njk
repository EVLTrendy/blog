{% macro comparisonTable(tableData) %}
<div class="comparison-table-container" data-table-id="{{ tableData.id }}">
  {% if tableData.title %}
  <h3 class="comparison-title">{{ tableData.title }}</h3>
  {% endif %}

  {% if tableData.filters %}
  <div class="table-filters">
    <label for="filter-{{ tableData.id }}">Filter by:</label>
    <select id="filter-{{ tableData.id }}" class="filter-select">
      <option value="all">All</option>
      {% for filter in tableData.filters %}
      <option value="{{ filter.value }}">{{ filter.label }}</option>
      {% endfor %}
    </select>
  </div>
  {% endif %}

  <div class="table-wrapper">
    <table class="comparison-table">
      <thead>
        <tr>
          {% for header in tableData.headers %}
          <th data-sortable="{{ header.sortable | default(false) }}" data-column="{{ loop.index0 }}">
            {{ header.label }}
            {% if header.sortable %}
            <span class="sort-icon">⇅</span>
            {% endif %}
          </th>
          {% endfor %}
        </tr>
      </thead>
      <tbody>
        {% for row in tableData.rows %}
        <tr data-category="{{ row.category | default('all') }}">
          {% for cell in row.cells %}
          <td data-label="{{ tableData.headers[loop.index0].label }}">
            {% if cell.type == 'check' %}
              <span class="check-icon">✓</span>
            {% elif cell.type == 'cross' %}
              <span class="cross-icon">✗</span>
            {% elif cell.type == 'rating' %}
              <div class="rating-stars">
                {% for i in range(1, 6) %}
                  <span class="star {{ 'filled' if i <= cell.value else '' }}">★</span>
                {% endfor %}
              </div>
            {% elif cell.type == 'badge' %}
              <span class="badge badge-{{ cell.variant | default('default') }}">{{ cell.value }}</span>
            {% elif cell.type == 'link' %}
              <a href="{{ cell.url }}" class="table-link" target="_blank" rel="noopener">{{ cell.value }}</a>
            {% else %}
              {{ cell.value }}
            {% endif %}
          </td>
          {% endfor %}
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  {% if tableData.note %}
  <p class="table-note">{{ tableData.note }}</p>
  {% endif %}
</div>

<style>
.comparison-table-container {
  margin: 2rem 0;
  background: white;
  border-radius: 12px;
  box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
  overflow: hidden;
}

.comparison-title {
  padding: 1.5rem;
  margin: 0;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  font-size: 1.5rem;
  font-weight: 700;
}

.table-filters {
  padding: 1rem 1.5rem;
  background: #f9fafb;
  border-bottom: 1px solid #e5e7eb;
  display: flex;
  align-items: center;
  gap: 1rem;
}

.table-filters label {
  font-weight: 600;
  color: #374151;
}

.filter-select {
  padding: 0.5rem 1rem;
  border: 1px solid #d1d5db;
  border-radius: 6px;
  background: white;
  font-size: 0.875rem;
  cursor: pointer;
  transition: border-color 0.2s ease;
}

.filter-select:hover {
  border-color: #667eea;
}

.filter-select:focus {
  outline: none;
  border-color: #667eea;
  box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
}

.table-wrapper {
  overflow-x: auto;
}

.comparison-table {
  width: 100%;
  border-collapse: collapse;
}

.comparison-table thead {
  background: #f9fafb;
  border-bottom: 2px solid #e5e7eb;
}

.comparison-table th {
  padding: 1rem 1.5rem;
  text-align: left;
  font-weight: 600;
  color: #111827;
  font-size: 0.875rem;
  text-transform: uppercase;
  letter-spacing: 0.05em;
  white-space: nowrap;
}

.comparison-table th[data-sortable="true"] {
  cursor: pointer;
  user-select: none;
  transition: background-color 0.2s ease;
}

.comparison-table th[data-sortable="true"]:hover {
  background: #f3f4f6;
}

.sort-icon {
  margin-left: 0.5rem;
  opacity: 0.5;
  font-size: 0.75rem;
}

.comparison-table tbody tr {
  border-bottom: 1px solid #e5e7eb;
  transition: background-color 0.2s ease;
}

.comparison-table tbody tr:hover {
  background: #f9fafb;
}

.comparison-table tbody tr.hidden {
  display: none;
}

.comparison-table td {
  padding: 1rem 1.5rem;
  color: #374151;
}

.check-icon {
  color: #10b981;
  font-size: 1.25rem;
  font-weight: 700;
}

.cross-icon {
  color: #ef4444;
  font-size: 1.25rem;
  font-weight: 700;
}

.rating-stars {
  display: flex;
  gap: 0.25rem;
}

.star {
  color: #d1d5db;
  font-size: 1.25rem;
}

.star.filled {
  color: #fbbf24;
}

.badge {
  display: inline-block;
  padding: 0.25rem 0.75rem;
  border-radius: 9999px;
  font-size: 0.75rem;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.05em;
}

.badge-default {
  background: #e5e7eb;
  color: #374151;
}

.badge-success {
  background: #d1fae5;
  color: #065f46;
}

.badge-warning {
  background: #fef3c7;
  color: #92400e;
}

.badge-danger {
  background: #fee2e2;
  color: #991b1b;
}

.badge-info {
  background: #dbeafe;
  color: #1e40af;
}

.table-link {
  color: #667eea;
  text-decoration: none;
  font-weight: 500;
  transition: color 0.2s ease;
}

.table-link:hover {
  color: #764ba2;
  text-decoration: underline;
}

.table-note {
  padding: 1rem 1.5rem;
  margin: 0;
  background: #f9fafb;
  border-top: 1px solid #e5e7eb;
  font-size: 0.875rem;
  color: #6b7280;
  font-style: italic;
}

/* Mobile responsive */
@media (max-width: 768px) {
  .comparison-table-container {
    margin: 1.5rem -1rem;
    border-radius: 0;
  }

  .comparison-table thead {
    display: none;
  }

  .comparison-table tbody tr {
    display: block;
    margin-bottom: 1rem;
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    overflow: hidden;
  }

  .comparison-table td {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.75rem 1rem;
    border-bottom: 1px solid #f3f4f6;
  }

  .comparison-table td:last-child {
    border-bottom: none;
  }

  .comparison-table td::before {
    content: attr(data-label);
    font-weight: 600;
    color: #111827;
    margin-right: 1rem;
  }
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const tables = document.querySelectorAll('.comparison-table-container');
  
  tables.forEach(container => {
    const table = container.querySelector('.comparison-table');
    const filterSelect = container.querySelector('.filter-select');
    const sortableHeaders = container.querySelectorAll('th[data-sortable="true"]');
    
    // Filter functionality
    if (filterSelect) {
      filterSelect.addEventListener('change', function() {
        const filterValue = this.value;
        const rows = table.querySelectorAll('tbody tr');
        
        rows.forEach(row => {
          const category = row.dataset.category || 'all';
          if (filterValue === 'all' || category === filterValue) {
            row.classList.remove('hidden');
          } else {
            row.classList.add('hidden');
          }
        });
        
        // Track filter usage
        if (typeof gtag !== 'undefined') {
          gtag('event', 'table_filter', {
            table_id: container.dataset.tableId,
            filter_value: filterValue
          });
        }
      });
    }
    
    // Sort functionality
    sortableHeaders.forEach(header => {
      let sortDirection = 'asc';
      
      header.addEventListener('click', function() {
        const columnIndex = parseInt(this.dataset.column);
        const rows = Array.from(table.querySelectorAll('tbody tr'));
        
        // Toggle sort direction
        sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
        
        // Sort rows
        rows.sort((a, b) => {
          const aValue = a.children[columnIndex].textContent.trim();
          const bValue = b.children[columnIndex].textContent.trim();
          
          // Try to parse as numbers
          const aNum = parseFloat(aValue);
          const bNum = parseFloat(bValue);
          
          if (!isNaN(aNum) && !isNaN(bNum)) {
            return sortDirection === 'asc' ? aNum - bNum : bNum - aNum;
          }
          
          // String comparison
          return sortDirection === 'asc' 
            ? aValue.localeCompare(bValue)
            : bValue.localeCompare(aValue);
        });
        
        // Re-append sorted rows
        const tbody = table.querySelector('tbody');
        rows.forEach(row => tbody.appendChild(row));
        
        // Update sort icon
        sortableHeaders.forEach(h => h.classList.remove('sorted-asc', 'sorted-desc'));
        this.classList.add(`sorted-${sortDirection}`);
        
        // Track sort usage
        if (typeof gtag !== 'undefined') {
          gtag('event', 'table_sort', {
            table_id: container.dataset.tableId,
            column_index: columnIndex,
            direction: sortDirection
          });
        }
      });
    });
  });
});
</script>
{% endmacro %}
